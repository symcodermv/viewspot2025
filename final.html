<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIEWSPOT - Complete Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    


    
    <style>
        /* Custom font for Dhivehi */
        @font-face {
            font-family: 'Faruma';
            src: url('fonts/Mv_MAG_Round_XBold.otf');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a311e 0%, #2d4b32 100%);
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a9e5b;
        }
        
        .login-form .form-group {
            margin-bottom: 15px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #4a9e5b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .login-form button:hover {
            background-color: #3a7d48;
        }
        
        .owner-options {
            margin-top: 20px;
            text-align: center;
        }
        
        .owner-btn {
            background: none;
            border: none;
            color: #4a9e5b;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Full screen button */
        .fullscreen-btn {
            position: absolute;
            left: 70px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .fullscreen-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Exit Full Screen Button */
        .exit-fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        body.fullscreen-mode .exit-fullscreen-btn {
            display: block;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #1a311e;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #2d4b32;
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            color: #f8a31c;
            font-size: 22px;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 40px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
            font-family: 'Faruma', sans-serif;
            font-size: larger;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #2d4b32;
            color: white;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            color: #000b72;
            font-size: 24px;
            font-family: 'Faruma', sans-serif;
        }
        
        .logout-btn {
            background-color: #f8a31c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background-color: #e5940c;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .stat-card p {
            color: #666;
            font-size: 16px;
            font-family: 'Faruma', sans-serif;
        }
        
        .profit {
            color: #4a9e5b;
        }
        
        .loss {
            color: #dc3545;
        }
        
        .expense-color {
            color: #dc3545;
        }
        
        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .content-section h2 {
            margin-bottom: 15px;
            color: #4a9e5b;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            background-color: #4a9e5b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .thaana-heading {
            font-family: "Noto Sans Thaana", "MV Waheed", "Faruma", sans-serif;
        }
        
        .btn:hover {
            background-color: #3a7d48;
        }
        
        .btn-secondary {
            background-color: #f8a31c;
        }
        
        .btn-secondary:hover {
            background-color: #e5940c;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }

        .thaana-text{
            font-family: 'Faruma', sans-serif;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            border-radius: 8px;
            max-width: 800px;
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #333;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        /* Payment slip image */
        .payment-slip {
            max-width: 100%;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4a9e5b;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1050;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-error {
            background-color: #dc3545;
        }
        
        .notification-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #4a9e5b;
            color: #4a9e5b;
            font-weight: 500;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* User Management */
        .user-list {
            margin-top: 20px;
        }
        
        .user-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
        }
        
        .user-info p {
            color: #666;
            font-size: 14px;
        }
        
        /* Developer Watermark */
        .developer-watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        
        /* POS Styles */
        .pos-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .pos-products {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .pos-product-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pos-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .pos-product-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .pos-product-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .pos-product-card p {
            color: #4a9e5b;
            font-weight: 500;
        }
        
        .pos-cart {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pos-cart h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background-color: #f8a31c;
            color: white;
            cursor: pointer;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
            text-align: right;
        }
        
        .payment-options {
            margin-bottom: 15px;
        }
        
        .payment-option {
            margin-bottom: 10px;
        }
        
        .customer-selection {
            margin-bottom: 15px;
        }
        
        .customer-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .customer-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
            flex: 1;
        }
        
        .customer-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .customer-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
        }
        
        .customer-item.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .customer-credit {
            font-size: 12px;
            color: #666;
        }
        
        .pos-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Bill Styles */
        .bill-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bill-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .order-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f8a31c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .bill-items {
            margin-bottom: 20px;
        }
        
        .bill-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .bill-total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            text-align: right;
        }
        
        /* Stock Management */
        .stock-alert {
            color: #dc3545;
            font-weight: 500;
        }
        
        /* Credit Management */
        .credit-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .credit-status.paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .credit-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .credit-status.overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Chart Containers */
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        /* Balance Sheet */
        .balance-sheet {
            margin-top: 20px;
        }
        
        .balance-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .balance-row.total {
            font-weight: bold;
            border-top: 2px solid #ddd;
        }
        
        /* Expenses Management */
        .expense-form {
            margin-bottom: 20px;
        }
        
        /* Quotation/Invoice Styles */
        .document-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .document-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: rgb(15, 7, 89);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .document-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .document-from, .document-to {
            flex: 1;
        }
        
        .document-items {
            width: 100%;
            margin-bottom: 30px;
        }
        
        .document-summary {
            margin-left: auto;
            width: 300px;
        }
        
        .document-footer {
            margin-top: 50px;
            text-align: center;
        }
        
        .table-selection {
            margin-bottom: 15px;
        }
        
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .table-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .table-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .table-btn.occupied {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .pos-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Order Type Selection */
        .order-type-selection {
            margin-bottom: 15px;
        }
        
        .order-type-buttons {
            display: flex;
            gap: 10px;
        }
        
        .order-type-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
            flex: 1;
        }
        
        .order-type-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        /* Quick Edit Product Modal */
        .quick-edit-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
        }
        
        .quick-edit-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        /* Financial Overview 2025 Style */
        .financial-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .financial-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .financial-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4a9e5b, #2d4b32);
        }
        
        .financial-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-family: 'Faruma', sans-serif;
        }
        
        .financial-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .financial-change {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .financial-change.positive {
            color: #4a9e5b;
        }
        
        .financial-change.negative {
            color: #dc3545;
        }
        
        .financial-trend {
            margin-top: 15px;
            height: 40px;
        }
        
        /* Enhanced Invoice Styles */
        .invoice-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4a9e5b;
            padding-bottom: 20px;
        }
        
        .invoice-logo {
            font-size: 24px;
            font-weight: bold;
            color: #4a9e5b;
            margin-bottom: 10px;
        }
        
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .invoice-from, .invoice-to {
            flex: 1;
        }
        
        .invoice-items {
            width: 100%;
            margin-bottom: 30px;
            border-collapse: collapse;
        }
        
        .invoice-items th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .invoice-items td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-summary {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 30px;
        }
        
        .invoice-totals {
            width: 300px;
        }
        
        .invoice-total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }
        
        .invoice-total-row.grand-total {
            font-weight: bold;
            border-top: 2px solid #ddd;
            padding-top: 12px;
            margin-top: 5px;
        }
        
        .invoice-footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .invoice-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Full Screen Invoice */
        .invoice-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .invoice-fullscreen .invoice-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .fullscreen-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2001;
            display: flex;
            gap: 10px;
        }
        
        /* NEW STYLES FOR POS IMPROVEMENTS */
        .pos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-search {
            flex: 1;
            margin-right: 15px;
        }
        
        .product-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .category-tab {
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .category-tab.active {
            background-color: #4a9e5b;
            color: white;
        }
        
        .quantity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .quantity-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        
        .quantity-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
        }
        
        .send-credit-btn {
            background-color: #17a2b8;
            margin-top: 10px;
        }
        
        .send-credit-btn:hover {
            background-color: #138496;
        }
        
        /* NEW: Table Customer Management */
        .table-customer-management {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .table-customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table-customer-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .table-customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .table-customer-name {
            font-weight: 500;
        }
        
        .table-customer-actions {
            display: flex;
            gap: 5px;
        }
        
        .add-customer-btn {
            width: 100%;
            padding: 8px;
            background-color: #4a9e5b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-customer-btn:hover {
            background-color: #3a7d48;
        }
        
        /* NEW: Customer Name Input Modal */
        .customer-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .customer-name-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        
        .customer-name-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        /* NEW: Customer Selection for Held Orders */
        .held-order-customer-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .held-order-customer-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .held-order-customer-item:hover {
            background-color: #e9e9e9;
        }
        
        .held-order-customer-item.active {
            background-color: #4a9e5b;
            color: white;
        }
        
        /* NEW: Enhanced Cart Controls */
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .quantity-control-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: #4a9e5b;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .quantity-control-btn:hover {
            background-color: #3a7d48;
        }
        
        .quantity-control-btn.remove {
            background-color: #dc3545;
        }
        
        .quantity-control-btn.remove:hover {
            background-color: #c82333;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .pos-container {
                flex-direction: column;
            }
            
            .document-details {
                flex-direction: column;
            }
            
            .document-summary {
                width: 100%;
            }
            
            .financial-cards {
                grid-template-columns: 1fr;
            }
            
            .invoice-details {
                flex-direction: column;
                gap: 20px;
            }
            
            .invoice-summary {
                justify-content: flex-start;
            }
            
            .invoice-totals {
                width: 100%;
            }
            
            .pos-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .product-search {
                margin-right: 0;
                width: 100%;
            }
        }
    </style>
    <style>
        /* Enhanced invoice styles */
.invoice-logo img {
    max-width: 150px;
    max-height: 80px;
    display: block;
    margin: 0 auto 10px;
}

.bank-details {
    margin-top: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
    border-left: 4px solid #4a9e5b;
}

.document-notes {
    margin-top: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
}

.invoice-footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

/* Enhanced settings form */
.settings-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.settings-section h3 {
    color: #4a9e5b;
    margin-bottom: 15px;
    font-size: 18px;
}
    </style>
      <style>
        /* Previous styles remain the same */
        
        /* Logo Upload Styles */
        .logo-upload-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            background-color: #f9f9f9;
        }
        
        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px auto;
            display: block;
        }
        
        .logo-upload-btn {
            background-color: #4a9e5b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .logo-upload-btn:hover {
            background-color: #3a7d48;
        }
        
        .logo-remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .logo-remove-btn:hover {
            background-color: #c82333;
        }
        
        .logo-upload-instructions {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        /* Enhanced Invoice Header Styles */
        .invoice-header-center {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .invoice-logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .invoice-logo-img {
            max-width: 150px;
            max-height: 80px;
            margin-bottom: 10px;
        }
        
        .invoice-store-name {
            font-size: 24px;
            font-weight: bold;
            color: #4a9e5b;
            margin: 5px 0;
        }
        
        .invoice-store-details {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        
        .document-title {
            font-size: 20px;
            font-weight: bold;
            margin: 15px 0;
            color: #333;
            border-top: 2px solid #4a9e5b;
            border-bottom: 2px solid #4a9e5b;
            padding: 8px 0;
        }
    </style>
</head>
<body>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>VIEWSPOT</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button class="btn" id="loginBtn">Login</button>
            
            <div class="owner-options">
                <button class="owner-btn" id="ownerBtn">Owner Options</button>
            </div>
        </div>
    </div>

    <!-- Owner Password Modal -->
    <div id="ownerPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-modal" id="closeOwnerPasswordModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Owner Authentication</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ownerPassword">Enter Owner Password</label>
                    <input type="password" id="ownerPassword" placeholder="Enter owner password">
                </div>
                <button class="btn" id="submitOwnerPassword">Submit</button>
            </div>
        </div>
    </div>

    <!-- Owner Modal -->
    <div id="ownerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOwnerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Owner Options</h2>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-subtab="create-user">Create User</div>
                    <div class="tab" data-subtab="user-list">User List</div>
                </div>
                
                <div id="create-user" class="tab-content active">
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" required>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Access Control</label>
                            <div>
                                <label><input type="checkbox" name="access" value="dashboard" checked> Dashboard</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="orders" checked> Orders</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="products" checked> Products</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="categories" checked> Categories</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="stock"> Stock Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="customers"> Customer Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="credit"> Credit Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="pos"> POS System</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="expenses"> Expenses Management</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="documents"> Documents</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="settings"> Settings</label>
                            </div>
                        </div>
                        <button type="submit" class="btn">Create User</button>
                    </form>
                </div>
                
                <div id="user-list" class="tab-content">
                    <div class="user-list" id="userListContainer">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>VIEWSPOT</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> ޑޭޝްބޯޑް</a></li>
                <li><a href="#" data-tab="pos"><i class="fas fa-cash-register"></i> ވިއްކުމުގެ ނިޒާމް</a></li>
                <li><a href="#" data-tab="orders"><i class="fas fa-shopping-cart"></i> ވިއްކުންތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="products"><i class="fas fa-glass"></i> އައިޓަމް</a></li>
                <li><a href="#" data-tab="categories"><i class="fas fa-tags"></i> ބާވަތްތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="stock"><i class="fas fa-boxes"></i> ސްޓޮކް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="customers"><i class="fas fa-users"></i> ކަސްޓަމާސް</a></li>
                <li><a href="#" data-tab="credit"><i class="fas fa-credit-card"></i> ކްރެޑިޓް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="expenses"><i class="fas fa-money-bill"></i> ޚަރަދުތައް ބެލެހެއްޓުން</a></li>
                <li><a href="#" data-tab="documents"><i class="fas fa-file-invoice"></i> ޑޮކިއުމަންސް</a></li>
                <li><a href="#" data-tab="settings"><i class="fas fa-cog"></i> ސެޓިން</a></li>
            </ul>
        </div>
        
        <!-- Exit Full Screen Button -->
        <button class="exit-fullscreen-btn" id="exit-fullscreen-btn">
            <i class="fas fa-compress"></i>
        </button>
        
        <!-- Full screen button moved to left side -->
        <button class="fullscreen-btn" id="fullscreen-btn">
            <i class="fas fa-expand"></i>
        </button>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>ޑޭޝްބޯޑް</h1>
                <div>
                    <span id="currentUserInfo" style="margin-right: 15px;"></span>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Dashboard content remains the same -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <h3 id="totalOrders">0</h3>
                        <p>ޖުމްލަ އޯޑަރު</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="totalCustomers">0</h3>
                        <p>ކަސްޓަމަރުން</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-coins"></i>
                        <h3 id="totalRevenue">MVR 0</h3>
                        <p>ޖުމްލަ ސޭލްސް</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3 id="netProfit" class="profit">MVR 0</h3>
                        <p>ސާފު ފައިދާ/ގެއްލުން</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-pause-circle"></i>
                        <h3 id="heldOrdersCount">0</h3>
                        <p>ހިފެހެއްޓިފައިވާ ވިއްކުންތައް</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-credit-card"></i>
                        <h3 id="creditCustomersCount">0</h3>
                        <p>ކްރެޑިޓް ކަސްޓަމަރުން</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-file-invoice-dollar expense-color"></i>
                        <h3 id="totalExpenses" class="expense-color">MVR 0</h3>
                        <p>ޖުމްލަ ޚަރަދު</p>
                    </div>
                </div>

                <!-- Financial Overview 2025 Style -->
                <div class="content-section">
                    <h2 class="thaana-heading">ފައިނޭންޝިއަލް އޯވަރވިވް</h2>

                    <div class="financial-cards">
                        <div class="financial-card">
                            <h3>އާމްދަނީ</h3>
                            <div class="financial-value" id="revenueValue">MVR 0.00</div>
                            <div class="financial-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="revenueChange"class="thaana-text">0% ފާއިތުވި މަހުން</span>
                            </div>
                            <div class="financial-trend">
                                <canvas id="revenueTrend"></canvas>
                            </div>
                        </div>
                        <div class="financial-card">
                            <h3>ޚަރަދު</h3>
                            <div class="financial-value" id="expensesValue">MVR 0.00</div>
                            <div class="financial-change negative">
                                <i class="fas fa-arrow-down"></i>
                                <span id="expensesChange" class="thaana-text">0% ފައިތުވި މަހުން</span>
                            </div>
                            <div class="financial-trend">
                                <canvas id="expensesTrend"></canvas>
                            </div>
                        </div>
                        <div class="financial-card">
                            <h3>ފައިދާ</h3>
                            <div class="financial-value" id="profitValue">MVR 0.00</div>
                            <div class="financial-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="profitChange"class="thaana-text">0% ފާއިތުވި މަހުން</span>
                            </div>
                            <div class="financial-trend">
                                <canvas id="profitTrend"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="profitLossChart"></canvas>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Balance Sheet</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="balanceDateFrom">From:</label>
                            <input type="date" id="balanceDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="balanceDateTo">To:</label>
                            <input type="date" id="balanceDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterBalanceBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportBalanceExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportBalancePdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="balance-sheet" id="balanceSheet">
                        <!-- Balance sheet will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- POS System Tab - IMPROVED -->
            <div id="pos" class="tab-content">
                <div class="content-section">
                    <div class="pos-header">
                        <div class="product-search">
                            <input type="text" id="productSearch" placeholder="Search products...">
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="refreshProductsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="category-tabs" id="categoryTabs">
                        <!-- Category tabs will be loaded here -->
                    </div>
                    
                    <div class="pos-container">
                        <div class="pos-products" id="posProducts">
                            <!-- Products will be loaded here -->
                        </div>
                        <div class="pos-cart">
                            <!-- Order Type Selection -->
                            <div class="order-type-selection">
                                <label>Order Type:</label>
                                <div class="order-type-buttons">
                                    <div class="order-type-btn active" id="diningBtn">Dining</div>
                                    <div class="order-type-btn" id="takeawayBtn">Takeaway</div>
                                </div>
                            </div>
                            
                            <div class="table-selection" id="tableSelection">
                                <label>Table Number:</label>
                                <div class="table-grid" id="tableGrid">
                                    <!-- Tables will be loaded here -->
                                </div>
                            </div>
                            
                            <!-- NEW: Table Customer Management -->
                            <div class="table-customer-management" id="tableCustomerManagement" style="display: none;">
                                <div class="table-customer-header">
                                    <h4>Table Customers</h4>
                                    <button class="btn btn-secondary" id="addCustomerToTableBtn">Add Customer</button>
                                </div>
                                <div class="table-customer-list" id="tableCustomerList">
                                    <!-- Table customers will be loaded here -->
                                </div>
                                <div class="customer-selection">
                                    <label>Select Customer:</label>
                                    <select id="tableCustomerSelect" class="form-group">
                                        <option value="">Select Customer</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="customer-selection">
                                <label>Select Customer Type:</label>
                                <div class="customer-buttons">
                                    <div class="customer-btn active" id="cashCustomerBtn">Cash Customer</div>
                                    <div class="customer-btn" id="creditCustomerBtn">Credit Customer</div>
                                </div>
                                
                                <div id="cashCustomerSection">
                                    <div class="form-group">
                                        <input type="text" id="cashCustomerName" placeholder="Customer Name (Required)">
                                    </div>
                                </div>
                                
                                <div id="creditCustomerSection" style="display: none;">
                                    <label>Select Credit Customer:</label>
                                    <div class="customer-grid" id="creditCustomerGrid">
                                        <!-- Credit customers will be loaded here -->
                                    </div>
                                    <div id="creditBalanceInfo" style="margin-top: 10px; font-weight: 500;"></div>
                                </div>
                            </div>
                            <div class="cart-items" id="cartItems">
                                <!-- Cart items will be displayed here -->
                                <p class="empty-cart">No items added yet</p>
                            </div>
                            <div class="cart-total" id="cartTotal">
                                Total: MVR 0.00
                            </div>
                            <div class="payment-options">
                                <label>Payment Method:</label>
                                <div class="payment-option">
                                    <input type="radio" id="cashPayment" name="paymentMethod" value="cash" checked>
                                    <label for="cashPayment">Cash</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="creditPayment" name="paymentMethod" value="credit">
                                    <label for="creditPayment">Credit</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="bankTransfer" name="paymentMethod" value="bank-transfer">
                                    <label for="bankTransfer">Bank Transfer</label>
                                </div>
                            </div>
                            <div class="pos-actions">
                                <button class="btn btn-danger" id="clearCartBtn">Clear</button>
                                <button class="btn btn-secondary" id="holdOrderBtn">Hold Order</button>
                                <button class="btn" id="completeOrderBtn">Complete Order</button>
                                <button class="btn send-credit-btn" id="sendCreditBtn" style="display: none;">Send Credit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Held Orders</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="heldOrderCustomerFilter">Customer Name:</label>
                            <input type="text" id="heldOrderCustomerFilter" placeholder="Filter by customer name">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterHeldOrdersBtn">Filter</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="heldOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Table</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Held orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <div class="content-section">
                    <h2>Order Management</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="orderStatusFilter">Status:</label>
                            <select id="orderStatusFilter">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="on-the-way">On the Way</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="orderDateFrom">From:</label>
                            <input type="date" id="orderDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="orderDateTo">To:</label>
                            <input type="date" id="orderDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterOrdersBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here -->
                            </tbody>
                            <tfoot id="ordersTableFooter">
                                <!-- Footer for totals -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div class="content-section">
                    <h2>Add New Product</h2>
                    <form id="addProductForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label for="productCategory">Category</label>
                                <select id="productCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice">Price (MVR)</label>
                                <input type="number" id="productPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="productStock">Stock (Optional)</label>
                                <input type="number" id="productStock" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productImage">Image URL</label>
                            <input type="text" id="productImage" placeholder="https://example.com/image.jpg">
                        </div>
                        <button type="submit" class="btn">Add Product</button>
                    </form>
                </div>
                
                <div class="content-section">
                    <h2>Product List</h2>
                    <div class="table-responsive">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <div class="content-section">
                    <h2>Add New Category</h2>
                    <form id="addCategoryForm">
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" id="categoryName" required>
                        </div>
                        <button type="submit" class="btn">Add Category</button>
                    </form>
                </div>
                
                <div class="content-section">
                    <h2>Category List</h2>
                    <div class="table-responsive">
                        <table id="categoriesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Categories will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Management Tab -->
            <div id="stock" class="tab-content">
                <div class="tabs">
                    <div class="tab active" data-subtab="stock-overview">Stock Overview</div>
                    <div class="tab" data-subtab="stock-adjustment">Stock Adjustment</div>
                    <div class="tab" data-subtab="stock-history">Stock History</div>
                </div>
                
                <div id="stock-overview" class="tab-content active">
                    <div class="content-section">
                        <h2>Stock Overview</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="stockStatusFilter">Status:</label>
                                <select id="stockStatusFilter">
                                    <option value="">All</option>
                                    <option value="low">Low Stock</option>
                                    <option value="out">Out of Stock</option>
                                    <option value="sufficient">Sufficient</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterStockBtn">Filter</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportStockExcelBtn">Export Excel</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportStockPdfBtn">Export PDF</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="stockTable">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Category</th>
                                        <th>Current Stock</th>
                                        <th>Minimum Stock</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Stock will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="stock-adjustment" class="tab-content">
                    <div class="content-section">
                        <h2>Stock Adjustment</h2>
                        <form id="stockAdjustmentForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="adjustmentProduct">Product</label>
                                    <select id="adjustmentProduct" required>
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="adjustmentType">Adjustment Type</label>
                                    <select id="adjustmentType" required>
                                        <option value="add">Add Stock</option>
                                        <option value="remove">Remove Stock</option>
                                        <option value="set">Set Stock</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="adjustmentQuantity">Quantity</label>
                                    <input type="number" id="adjustmentQuantity" min="1" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="adjustmentNotes">Notes</label>
                                <textarea id="adjustmentNotes"></textarea>
                            </div>
                            <button type="submit" class="btn">Adjust Stock</button>
                        </form>
                    </div>
                </div>
                
                <div id="stock-history" class="tab-content">
                    <div class="content-section">
                        <h2>Stock History</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="stockHistoryProduct">Product:</label>
                                <select id="stockHistoryProduct">
                                    <option value="">All Products</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="stockHistoryDateFrom">From:</label>
                                <input type="date" id="stockHistoryDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="stockHistoryDateTo">To:</label>
                                <input type="date" id="stockHistoryDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterStockHistoryBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="stockHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Product</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Previous Stock</th>
                                        <th>New Stock</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Stock history will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Management Tab -->
            <div id="customers" class="tab-content">
                <div class="content-section">
                    <h2>Add New Customer</h2>
                    <form id="addCustomerForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName">Customer Name</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerContact">Contact</label>
                                <input type="text" id="customerContact" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerJob">Job/Company</label>
                                <input type="text" id="customerJob">
                            </div>
                            <div class="form-group">
                                <label for="customerCreditLimit">Credit Limit (MVR)</label>
                                <input type="number" id="customerCreditLimit" step="0.01" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <textarea id="customerAddress"></textarea>
                        </div>
                        <button type="submit" class="btn">Add Customer</button>
                    </form>
                </div>
                
                <div class="content-section">
                    <h2>Customer List</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="customerSearch">Search:</label>
                            <input type="text" id="customerSearch" placeholder="Search by name or contact">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterCustomersBtn">Search</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportCustomersExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportCustomersPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="customersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Job/Company</th>
                                    <th>Address</th>
                                    <th>Credit Limit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Customers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Credit Management Tab - IMPROVED -->
            <div id="credit" class="tab-content">
                <div class="tabs">
                    <div class="tab active" data-subtab="credit-accounts">Credit Accounts</div>
                    <div class="tab" data-subtab="credit-transactions">Credit Transactions</div>
                    <div class="tab" data-subtab="credit-orders">Credit Orders</div>
                </div>
                
                <div id="credit-accounts" class="tab-content active">
                    <div class="content-section">
                        <h2>Credit Accounts</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="creditStatusFilter">Status:</label>
                                <select id="creditStatusFilter">
                                    <option value="">All</option>
                                    <option value="active">Active</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="settled">Settled</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterCreditBtn">Filter</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportCreditExcelBtn">Export Excel</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportCreditPdfBtn">Export PDF</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="creditTable">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Credit Limit</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Last Transaction</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Credit accounts will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="credit-transactions" class="tab-content">
                    <div class="content-section">
                        <h2>Credit Transactions</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="creditCustomerFilter">Customer:</label>
                                <select id="creditCustomerFilter">
                                    <option value="">All Customers</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="creditDateFrom">From:</label>
                                <input type="date" id="creditDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="creditDateTo">To:</label>
                                <input type="date" id="creditDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterCreditTransactionsBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="creditTransactionsTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Balance</th>
                                        <th>Order #</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Credit transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="credit-orders" class="tab-content">
                    <div class="content-section">
                        <h2>Credit Orders</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="creditOrderCustomerFilter">Customer:</label>
                                <select id="creditOrderCustomerFilter">
                                    <option value="">All Customers</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="creditOrderDateFrom">From:</label>
                                <input type="date" id="creditOrderDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="creditOrderDateTo">To:</label>
                                <input type="date" id="creditOrderDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterCreditOrdersBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="creditOrdersTable">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Credit orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Management Tab -->
            <div id="expenses" class="tab-content">
                <div class="tabs">
                    <div class="tab active" data-subtab="expense-entry">Expense Entry</div>
                    <div class="tab" data-subtab="expense-list">Expense List</div>
                </div>
                
                <div id="expense-entry" class="tab-content active">
                    <div class="content-section">
                        <h2>Add New Expense</h2>
                        <form id="addExpenseForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expenseDate">Date</label>
                                    <input type="date" id="expenseDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseSupplier">Supplier</label>
                                    <input type="text" id="expenseSupplier" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expenseInvoice">Invoice #</label>
                                    <input type="text" id="expenseInvoice">
                                </div>
                                <div class="form-group">
                                    <label for="expenseAmount">Amount (MVR)</label>
                                    <input type="number" id="expenseAmount" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="expenseNotes">Notes</label>
                                <textarea id="expenseNotes"></textarea>
                            </div>
                            <button type="submit" class="btn">Add Expense</button>
                        </form>
                    </div>
                </div>
                
                <div id="expense-list" class="tab-content">
                    <div class="content-section">
                        <h2>Expense List</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="expenseDateFrom">From:</label>
                                <input type="date" id="expenseDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="expenseDateTo">To:</label>
                                <input type="date" id="expenseDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterExpensesBtn">Filter</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportExpensesExcelBtn">Export Excel</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportExpensesPdfBtn">Export PDF</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="expensesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Invoice #</th>
                                        <th>Amount</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Expenses will be loaded here -->
                                </tbody>
                                <tfoot id="expensesTableFooter">
                                    <!-- Footer for totals -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="documents" class="tab-content">
                <div class="tabs">
                    <div class="tab active" data-subtab="quotation">Quotation</div>
                    <div class="tab" data-subtab="invoice">Invoice</div>
                    <div class="tab" data-subtab="document-list">Document List</div>
                </div>
                
                <div id="quotation" class="tab-content active">
                    <div class="content-section">
                        <h2>Create Quotation</h2>
                        <form id="quotationForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quotationCustomer">Customer</label>
                                    <select id="quotationCustomer" required>
                                        <option value="">Select Customer</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quotationNumber">Quotation #</label>
                                    <input type="text" id="quotationNumber" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quotationDate">Date</label>
                                    <input type="date" id="quotationDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="quotationValidUntil">Valid Until</label>
                                    <input type="date" id="quotationValidUntil" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="quotationNotes">Notes</label>
                                <textarea id="quotationNotes"></textarea>
                            </div>
                            
                            <h3>Items</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quotationProduct">Product</label>
                                    <select id="quotationProduct">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quotationQuantity">Quantity</label>
                                    <input type="number" id="quotationQuantity" min="1" value="1">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary" id="addQuotationItem">Add Item</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table id="quotationItemsTable">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Quotation items will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <button type="submit" class="btn">Generate Quotation</button>
                                <button type="button" class="btn btn-secondary" id="exportQuotationPdf">Export PDF</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="invoice" class="tab-content">
                    <div class="content-section">
                        <h2>Create Invoice</h2>
                        <form id="invoiceForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="invoiceCustomer">Customer</label>
                                    <select id="invoiceCustomer" required>
                                        <option value="">Select Customer</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceNumber">Invoice #</label>
                                    <input type="text" id="invoiceNumber" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="invoiceDate">Date</label>
                                    <input type="date" id="invoiceDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceDueDate">Due Date</label>
                                    <input type="date" id="invoiceDueDate" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="invoiceNotes">Notes</label>
                                <textarea id="invoiceNotes"></textarea>
                            </div>
                            
                            <h3>Items</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="invoiceProduct">Product</label>
                                    <select id="invoiceProduct">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="invoiceQuantity">Quantity</label>
                                    <input type="number" id="invoiceQuantity" min="1" value="1">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="button" class="btn btn-secondary" id="addInvoiceItem">Add Item</button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table id="invoiceItemsTable">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Invoice items will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <button type="submit" class="btn">Generate Invoice</button>
                                <button type="button" class="btn btn-secondary" id="exportInvoicePdf">Export PDF</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="document-list" class="tab-content">
                    <div class="content-section">
                        <h2>Document List</h2>
                        <div class="filters">
                            <div class="filter-group">
                                <label for="documentTypeFilter">Type:</label>
                                <select id="documentTypeFilter">
                                    <option value="">All</option>
                                    <option value="quotation">Quotation</option>
                                    <option value="invoice">Invoice</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="documentDateFrom">From:</label>
                                <input type="date" id="documentDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="documentDateTo">To:</label>
                                <input type="date" id="documentDateTo">
                            </div>
                            <div class="filter-group">
                                <button class="btn" id="filterDocumentsBtn">Filter</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="documentsTable">
                                <thead>
                                    <tr>
                                        <th>Document #</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Documents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           <!-- Settings Tab -->
   <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="content-section">
            <h2>Store Settings</h2>
            <form id="storeSettingsForm">
                <div class="settings-section">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label for="storeName">Store Name</label>
                        <input type="text" id="storeName" required>
                    </div>
                    <div class="form-group">
                        <label for="storeAddress">Store Address</label>
                        <textarea id="storeAddress"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="storePhone">Phone</label>
                            <input type="text" id="storePhone">
                        </div>
                        <div class="form-group">
                            <label for="storeEmail">Email</label>
                            <input type="email" id="storeEmail">
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Branding</h3>
                    <div class="logo-upload-container">
                        <h4>Company Logo</h4>
                        <div id="logoPreviewContainer">
                            <img id="logoPreview" class="logo-preview" style="display: none;">
                            <p id="noLogoText">No logo uploaded</p>
                        </div>
                        <div>
                            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                            <button type="button" class="logo-upload-btn" id="uploadLogoBtn">Upload Logo</button>
                            <button type="button" class="logo-remove-btn" id="removeLogoBtn" style="display: none;">Remove Logo</button>
                        </div>
                        <p class="logo-upload-instructions">
                            Recommended: PNG or JPG format, max 500KB. Logo will appear on invoices and quotations.
                        </p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Bank Details</h3>
                    <div class="form-group">
                        <label for="bankDetails">Bank Information</label>
                        <textarea id="bankDetails" placeholder="Bank Name: Your Bank Name&#10;Account Number: 123456789&#10;Account Holder: Your Company Name&#10;IBAN: Your IBAN (if applicable)&#10;Swift/BIC Code: Your Swift Code"></textarea>
                        <small>Enter your bank details (one per line). These will appear on invoices and quotations.</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>POS Settings</h3>
                    <div class="form-group">
                        <label for="tableCount">Number of Tables</label>
                        <input type="number" id="tableCount" min="1" max="50" value="10">
                    </div>
                </div>
                
                <button type="submit" class="btn">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Quantity Input Modal -->
    <div id="quantityModal" class="quantity-modal" style="display: none;">
        <div class="quantity-modal-content">
            <h3 id="quantityProductName">Enter Quantity</h3>
            <input type="number" id="quantityInput" class="quantity-input" min="1" value="1">
            <div class="pos-actions">
                <button class="btn btn-secondary" id="cancelQuantityBtn">Cancel</button>
                <button class="btn" id="confirmQuantityBtn">Add to Cart</button>
            </div>
        </div>
    </div>

    <!-- NEW: Customer Name Input Modal -->
    <div id="customerNameModal" class="customer-name-modal" style="display: none;">
        <div class="customer-name-modal-content">
            <h3>Enter Customer Name</h3>
            <input type="text" id="customerNameInput" class="customer-name-input" placeholder="Customer Name">
            <div class="pos-actions">
                <button class="btn btn-secondary" id="cancelCustomerNameBtn">Cancel</button>
                <button class="btn" id="confirmCustomerNameBtn">Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOrderModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Order Details</h2>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeOrderModalBtn">Close</button>
                <button class="btn btn-danger" id="deleteOrderBtn">Delete Order</button>
            </div>
        </div>
    </div>

    <!-- Credit Settlement Modal -->
    <div id="creditSettlementModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeCreditSettlementModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Settle Credit Account</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="settlementAmount">Settlement Amount (MVR)</label>
                    <input type="number" id="settlementAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="settlementMethod">Payment Method</label>
                    <select id="settlementMethod" required>
                        <option value="cash">Cash</option>
                        <option value="bank-transfer">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="settlementNotes">Notes</label>
                    <textarea id="settlementNotes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSettlementBtn">Cancel</button>
                <button class="btn" id="confirmSettlementBtn">Confirm Settlement</button>
            </div>
        </div>
    </div>

    <!-- Bill Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeBillModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Order Bill</h2>
            </div>
            <div class="modal-body" id="billModalBody">
                <!-- Bill content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeBillModalBtn">Close</button>
                <button class="btn" id="printBillBtn">Print Bill</button>
            </div>
        </div>
    </div>

    <!-- Document Preview Modal -->
    <div id="documentPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-modal" id="closeDocumentPreviewModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2 id="documentPreviewTitle">Document Preview</h2>
            </div>
            <div class="modal-body" id="documentPreviewBody">
                <!-- Document preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeDocumentPreviewBtn">Close</button>
                <button class="btn" id="printDocumentBtn">Print</button>
                <button class="btn btn-secondary" id="downloadDocumentPdf">Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Quick Edit Product Modal -->
    <div id="quickEditProductModal" class="quick-edit-overlay" style="display: none;">
        <div class="quick-edit-modal">
            <button class="close-modal" id="closeQuickEditModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Edit Product</h2>
            </div>
            <div class="modal-body">
                <form id="quickEditProductForm">
                    <input type="hidden" id="quickEditProductId">
                    <div class="form-group">
                        <label for="quickEditProductName">Product Name</label>
                        <input type="text" id="quickEditProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="quickEditProductCategory">Category</label>
                        <select id="quickEditProductCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quickEditProductPrice">Price (MVR)</label>
                        <input type="number" id="quickEditProductPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="quickEditProductStock">Stock</label>
                        <input type="number" id="quickEditProductStock" min="0">
                    </div>
                    <div class="form-group">
                        <label for="quickEditProductImage">Image URL</label>
                        <input type="text" id="quickEditProductImage">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelQuickEdit">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeEditCustomerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Edit Customer</h2>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="editCustomerId">
                    <div class="form-group">
                        <label for="editCustomerName">Customer Name</label>
                        <input type="text" id="editCustomerName" required>
                    </div>
                    <div class="form-group">
                        <label for="editCustomerContact">Contact</label>
                        <input type="text" id="editCustomerContact" required>
                    </div>
                    <div class="form-group">
                        <label for="editCustomerJob">Job/Company</label>
                        <input type="text" id="editCustomerJob">
                    </div>
                    <div class="form-group">
                        <label for="editCustomerAddress">Address</label>
                        <textarea id="editCustomerAddress"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editCustomerCreditLimit">Credit Limit (MVR)</label>
                        <input type="number" id="editCustomerCreditLimit" step="0.01" min="0">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelEditCustomer">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Developer Watermark -->
    <div class="developer-watermark">
        Developed by sym.codermv © 2025
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyButkIKCwwUnwXSm_1SsskPWOaSEtW9hBM",
            authDomain: "viewspot2025.firebaseapp.com",
            databaseURL: "https://viewspot2025-default-rtdb.firebaseio.com",
            projectId: "viewspot2025",
            storageBucket: "viewspot2025.firebasestorage.app",
            messagingSenderId: "965324919882",
            appId: "1:965324919882:web:e0b269f74f5aca34a382b3",
            measurementId: "G-RV0BJ03PSV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentOrderId = null;
        let currentCustomerId = null;
        let currentCreditAccountId = null;
        let currentUser = null;
        let userAccess = [];
        let cart = [];
        let currentCustomer = null;
        let heldOrders = {};
        let notifiedOrders = {};
        let currentTable = null;
        let profitLossChart = null;
        let revenueTrendChart = null;
        let expensesTrendChart = null;
        let profitTrendChart = null;
        let tablesCount = 10;
        let currentDocument = null;
        let currentOrderType = 'dining';
        let selectedProductForQuantity = null;
        let currentCategoryFilter = 'all';
        let tableCustomers = {}; // NEW: Store customers for each table
        let currentTableCustomer = null; // NEW: Currently selected table customer

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const ownerBtn = document.getElementById('ownerBtn');
        const ownerModal = document.getElementById('ownerModal');
        const ownerPasswordModal = document.getElementById('ownerPasswordModal');
        const closeOwnerModal = document.getElementById('closeOwnerModal');
        const closeOwnerPasswordModal = document.getElementById('closeOwnerPasswordModal');
        const submitOwnerPassword = document.getElementById('submitOwnerPassword');
        const createUserForm = document.getElementById('createUserForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const tabContents = document.querySelectorAll('.tab-content');
        const subtabTabs = document.querySelectorAll('[data-subtab]');
        const subtabContents = document.querySelectorAll('.tab-content .tab-content');
        const orderModal = document.getElementById('orderModal');
        const creditSettlementModal = document.getElementById('creditSettlementModal');
        const billModal = document.getElementById('billModal');
        const documentPreviewModal = document.getElementById('documentPreviewModal');
        const notificationContainer = document.getElementById('notificationContainer');
        const currentUserInfo = document.getElementById('currentUserInfo');
        const quickEditProductModal = document.getElementById('quickEditProductModal');
        const closeQuickEditModal = document.getElementById('closeQuickEditModal');
        const cancelQuickEdit = document.getElementById('cancelQuickEdit');
        const quickEditProductForm = document.getElementById('quickEditProductForm');
        const editCustomerModal = document.getElementById('editCustomerModal');
        const closeEditCustomerModal = document.getElementById('closeEditCustomerModal');
        const cancelEditCustomer = document.getElementById('cancelEditCustomer');
        const editCustomerForm = document.getElementById('editCustomerForm');

        // NEW POS elements
        const productSearch = document.getElementById('productSearch');
        const categoryTabs = document.getElementById('categoryTabs');
        const refreshProductsBtn = document.getElementById('refreshProductsBtn');
        const quantityModal = document.getElementById('quantityModal');
        const quantityProductName = document.getElementById('quantityProductName');
        const quantityInput = document.getElementById('quantityInput');
        const cancelQuantityBtn = document.getElementById('cancelQuantityBtn');
        const confirmQuantityBtn = document.getElementById('confirmQuantityBtn');
        const sendCreditBtn = document.getElementById('sendCreditBtn');

        // NEW: Customer name modal elements
        const customerNameModal = document.getElementById('customerNameModal');
        const customerNameInput = document.getElementById('customerNameInput');
        const cancelCustomerNameBtn = document.getElementById('cancelCustomerNameBtn');
        const confirmCustomerNameBtn = document.getElementById('confirmCustomerNameBtn');

        // NEW: Table customer management elements
        const tableCustomerManagement = document.getElementById('tableCustomerManagement');
        const tableCustomerList = document.getElementById('tableCustomerList');
        const addCustomerToTableBtn = document.getElementById('addCustomerToTableBtn');
        const tableCustomerSelect = document.getElementById('tableCustomerSelect');

        // Existing POS elements
        const tableGrid = document.getElementById('tableGrid');
        const tableSelection = document.getElementById('tableSelection');
        const posProducts = document.getElementById('posProducts');
        const diningBtn = document.getElementById('diningBtn');
        const takeawayBtn = document.getElementById('takeawayBtn');
        const cashCustomerBtn = document.getElementById('cashCustomerBtn');
        const creditCustomerBtn = document.getElementById('creditCustomerBtn');
        const cashCustomerSection = document.getElementById('cashCustomerSection');
        const creditCustomerSection = document.getElementById('creditCustomerSection');
        const creditCustomerGrid = document.getElementById('creditCustomerGrid');
        const creditBalanceInfo = document.getElementById('creditBalanceInfo');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const holdOrderBtn = document.getElementById('holdOrderBtn');
        const completeOrderBtn = document.getElementById('completeOrderBtn');
        const heldOrdersTable = document.getElementById('heldOrdersTable').querySelector('tbody');
        const printBillBtn = document.getElementById('printBillBtn');
        const closeBillModal = document.getElementById('closeBillModal');
        const closeBillModalBtn = document.getElementById('closeBillModalBtn');

        // NEW: Held orders filter
        const heldOrderCustomerFilter = document.getElementById('heldOrderCustomerFilter');
        const filterHeldOrdersBtn = document.getElementById('filterHeldOrdersBtn');

        // Credit settlement elements
        const closeCreditSettlementModal = document.getElementById('closeCreditSettlementModal');
        const cancelSettlementBtn = document.getElementById('cancelSettlementBtn');
        const confirmSettlementBtn = document.getElementById('confirmSettlementBtn');

        // Document elements
        const addQuotationItem = document.getElementById('addQuotationItem');
        const addInvoiceItem = document.getElementById('addInvoiceItem');
        const closeDocumentPreviewModal = document.getElementById('closeDocumentPreviewModal');
        const closeDocumentPreviewBtn = document.getElementById('closeDocumentPreviewBtn');
        const printDocumentBtn = document.getElementById('printDocumentBtn');
        const downloadDocumentPdf = document.getElementById('downloadDocumentPdf');
        const exportQuotationPdf = document.getElementById('exportQuotationPdf');
        const exportInvoicePdf = document.getElementById('exportInvoicePdf');

        // Initialize the admin panel
        function initAdmin() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userAccess = currentUser.access || [];
                showAdminPanel();
                updateUserInterface();
            } else {
                showLoginScreen();
            }

            // Login button event
            loginBtn.addEventListener('click', handleLogin);

            // Owner button event
            ownerBtn.addEventListener('click', () => {
                ownerPasswordModal.style.display = 'block';
            });

            // Owner password submission
            submitOwnerPassword.addEventListener('click', () => {
                const password = document.getElementById('ownerPassword').value;
                if (password === 'Anoof@25#') {
                    ownerPasswordModal.style.display = 'none';
                    ownerModal.style.display = 'block';
                    loadUsers();
                } else {
                    showNotification('Invalid owner password', 'error');
                }
            });

            // Close owner modals
            closeOwnerModal.addEventListener('click', () => {
                ownerModal.style.display = 'none';
            });
            
            closeOwnerPasswordModal.addEventListener('click', () => {
                ownerPasswordModal.style.display = 'none';
            });

            // Create user form
            createUserForm.addEventListener('submit', createUser);

            // Logout button event
            logoutBtn.addEventListener('click', handleLogout);

            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = link.dataset.tab;
                    
                    // Check if user has access to this tab
                    if (!userAccess.includes(tab) && tab !== 'dashboard') {
                        showNotification('You do not have access to this section', 'error');
                        return;
                    }
                    
                    switchTab(tab);
                    
                    // Update active state
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            // Sub-tab navigation
            subtabTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const subtab = tab.dataset.subtab;
                    switchSubTab(subtab);
                    
                    // Update active state
                    subtabTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Modal close buttons
            document.getElementById('closeOrderModal').addEventListener('click', () => orderModal.style.display = 'none');
            document.getElementById('closeOrderModalBtn').addEventListener('click', () => orderModal.style.display = 'none');
            closeCreditSettlementModal.addEventListener('click', () => creditSettlementModal.style.display = 'none');
            cancelSettlementBtn.addEventListener('click', () => creditSettlementModal.style.display = 'none');
            closeBillModal.addEventListener('click', () => billModal.style.display = 'none');
            closeBillModalBtn.addEventListener('click', () => billModal.style.display = 'none');
            closeDocumentPreviewModal.addEventListener('click', () => documentPreviewModal.style.display = 'none');
            closeDocumentPreviewBtn.addEventListener('click', () => documentPreviewModal.style.display = 'none');
            closeQuickEditModal.addEventListener('click', () => quickEditProductModal.style.display = 'none');
            cancelQuickEdit.addEventListener('click', () => quickEditProductModal.style.display = 'none');
            closeEditCustomerModal.addEventListener('click', () => editCustomerModal.style.display = 'none');
            cancelEditCustomer.addEventListener('click', () => editCustomerModal.style.display = 'none');

            // NEW: Customer name modal buttons
            cancelCustomerNameBtn.addEventListener('click', () => {
                customerNameModal.style.display = 'none';
            });
            
            confirmCustomerNameBtn.addEventListener('click', () => {
                const customerName = customerNameInput.value.trim();
                if (customerName) {
                    addCustomerToTable(currentTable, customerName);
                    customerNameModal.style.display = 'none';
                    customerNameInput.value = '';
                } else {
                    showNotification('Please enter a customer name', 'error');
                }
            });

            // NEW: Quantity modal buttons
            cancelQuantityBtn.addEventListener('click', () => {
                quantityModal.style.display = 'none';
                selectedProductForQuantity = null;
            });
            
            confirmQuantityBtn.addEventListener('click', () => {
                if (selectedProductForQuantity) {
                    const quantity = parseInt(quantityInput.value) || 1;
                    addToCartWithQuantity(selectedProductForQuantity.id, selectedProductForQuantity.product, quantity);
                    quantityModal.style.display = 'none';
                    selectedProductForQuantity = null;
                }
            });

            // NEW: Product search
            productSearch.addEventListener('input', filterProducts);

            // NEW: Refresh products button
            refreshProductsBtn.addEventListener('click', () => {
                loadProductsForPOS();
                showNotification('Products refreshed');
            });

            // NEW: Send credit button
            sendCreditBtn.addEventListener('click', sendToCreditManagement);

            // NEW: Add customer to table button
            addCustomerToTableBtn.addEventListener('click', () => {
                if (currentTable) {
                    customerNameModal.style.display = 'flex';
                    customerNameInput.focus();
                } else {
                    showNotification('Please select a table first', 'error');
                }
            });

            // NEW: Filter held orders by customer name
            filterHeldOrdersBtn.addEventListener('click', loadHeldOrders);

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === orderModal) orderModal.style.display = 'none';
                if (e.target === ownerModal) ownerModal.style.display = 'none';
                if (e.target === ownerPasswordModal) ownerPasswordModal.style.display = 'none';
                if (e.target === billModal) billModal.style.display = 'none';
                if (e.target === creditSettlementModal) creditSettlementModal.style.display = 'none';
                if (e.target === documentPreviewModal) documentPreviewModal.style.display = 'none';
                if (e.target === quickEditProductModal) quickEditProductModal.style.display = 'none';
                if (e.target === editCustomerModal) editCustomerModal.style.display = 'none';
                if (e.target === quantityModal) {
                    quantityModal.style.display = 'none';
                    selectedProductForQuantity = null;
                }
                if (e.target === customerNameModal) {
                    customerNameModal.style.display = 'none';
                }
            });

            // Delete buttons
            document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);

            // Filter buttons
            document.getElementById('filterOrdersBtn').addEventListener('click', loadOrders);
            document.getElementById('filterStockBtn').addEventListener('click', loadStock);
            document.getElementById('filterStockHistoryBtn').addEventListener('click', loadStockHistory);
            document.getElementById('filterCustomersBtn').addEventListener('click', loadCustomers);
            document.getElementById('filterCreditBtn').addEventListener('click', loadCreditAccounts);
            document.getElementById('filterCreditTransactionsBtn').addEventListener('click', loadCreditTransactions);
            document.getElementById('filterCreditOrdersBtn').addEventListener('click', loadCreditOrders);
            document.getElementById('filterExpensesBtn').addEventListener('click', loadExpenses);
            document.getElementById('filterDocumentsBtn').addEventListener('click', loadDocuments);
            document.getElementById('filterBalanceBtn').addEventListener('click', loadBalanceSheet);

            // Export buttons
            document.getElementById('exportOrdersExcelBtn').addEventListener('click', () => exportToExcel('orders'));
            document.getElementById('exportOrdersPdfBtn').addEventListener('click', () => exportToPdf('orders'));
            document.getElementById('exportStockExcelBtn').addEventListener('click', () => exportToExcel('stock'));
            document.getElementById('exportStockPdfBtn').addEventListener('click', () => exportToPdf('stock'));
            document.getElementById('exportCustomersExcelBtn').addEventListener('click', () => exportToExcel('customers'));
            document.getElementById('exportCustomersPdfBtn').addEventListener('click', () => exportToPdf('customers'));
            document.getElementById('exportCreditExcelBtn').addEventListener('click', () => exportToExcel('credit'));
            document.getElementById('exportCreditPdfBtn').addEventListener('click', () => exportToPdf('credit'));
            document.getElementById('exportExpensesExcelBtn').addEventListener('click', () => exportToExcel('expenses'));
            document.getElementById('exportExpensesPdfBtn').addEventListener('click', () => exportToPdf('expenses'));
            document.getElementById('exportBalanceExcelBtn').addEventListener('click', () => exportToExcel('balance'));
            document.getElementById('exportBalancePdfBtn').addEventListener('click', () => exportToPdf('balance'));

            // Form submissions
            document.getElementById('addProductForm').addEventListener('submit', addProduct);
            document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
            document.getElementById('addCustomerForm').addEventListener('submit', addCustomer);
            document.getElementById('addExpenseForm').addEventListener('submit', addExpense);
            document.getElementById('stockAdjustmentForm').addEventListener('submit', adjustStock);
            document.getElementById('storeSettingsForm').addEventListener('submit', saveStoreSettings);
            document.getElementById('editCustomerForm').addEventListener('submit', saveCustomerEdit);
            document.getElementById('quotationForm').addEventListener('submit', generateQuotation);
            document.getElementById('invoiceForm').addEventListener('submit', generateInvoice);
            quickEditProductForm.addEventListener('submit', saveQuickEditProduct);

            // POS buttons
            clearCartBtn.addEventListener('click', clearCart);
            holdOrderBtn.addEventListener('click', holdOrder);
            completeOrderBtn.addEventListener('click', completeOrder);
            printBillBtn.addEventListener('click', printBill);

            // Order type selection
            diningBtn.addEventListener('click', () => {
                diningBtn.classList.add('active');
                takeawayBtn.classList.remove('active');
                currentOrderType = 'dining';
                tableSelection.style.display = 'block';
                tableCustomerManagement.style.display = 'block';
            });

            takeawayBtn.addEventListener('click', () => {
                takeawayBtn.classList.add('active');
                diningBtn.classList.remove('active');
                currentOrderType = 'takeaway';
                tableSelection.style.display = 'none';
                tableCustomerManagement.style.display = 'none';
                currentTable = null;
                currentTableCustomer = null;
                
                // Deselect any selected table
                document.querySelectorAll('.table-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });

            // Customer type selection
            cashCustomerBtn.addEventListener('click', () => {
                cashCustomerBtn.classList.add('active');
                creditCustomerBtn.classList.remove('active');
                cashCustomerSection.style.display = 'block';
                creditCustomerSection.style.display = 'none';
                currentCustomerId = 'cash';
                currentCustomer = {name: document.getElementById('cashCustomerName').value || 'Cash Customer'};
                sendCreditBtn.style.display = 'none';
            });

            creditCustomerBtn.addEventListener('click', () => {
                creditCustomerBtn.classList.add('active');
                cashCustomerBtn.classList.remove('active');
                cashCustomerSection.style.display = 'none';
                creditCustomerSection.style.display = 'block';
                currentCustomerId = null;
                currentCustomer = null;
                sendCreditBtn.style.display = 'block';
            });

            // Credit settlement
            confirmSettlementBtn.addEventListener('click', settleCredit);

            // Document items
            addQuotationItem.addEventListener('click', addQuotationItemToTable);
            addInvoiceItem.addEventListener('click', addInvoiceItemToTable);
            printDocumentBtn.addEventListener('click', printDocument);
            downloadDocumentPdf.addEventListener('click', downloadDocumentAsPdf);
            exportQuotationPdf.addEventListener('click', () => exportQuotationAsPdf());
            exportInvoicePdf.addEventListener('click', () => exportInvoiceAsPdf());

            // Load initial data if logged in
            if (savedUser) {
                loadDashboardData();
                loadProducts();
                loadCategories();
                loadOrders();
                loadStock();
                loadCustomers();
                loadCreditAccounts();
                loadExpenses();
                loadStoreSettings();
                loadHeldOrders();
                loadTables();
                
                // Set up real-time listeners
                setupRealtimeListeners();
            }
        }

        // NEW: Filter products by search term
        function filterProducts() {
            const searchTerm = productSearch.value.toLowerCase();
            const productCards = document.querySelectorAll('.pos-product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('h3').textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // NEW: Load products with category organization
        function loadProductsForPOS() {
            if (!userAccess.includes('pos')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                posProducts.innerHTML = '';
                
                // Load categories for tabs
                database.ref('categories').once('value').then(catSnapshot => {
                    const categories = catSnapshot.val();
                    categoryTabs.innerHTML = '';
                    
                    // Add "All" tab
                    const allTab = document.createElement('div');
                    allTab.className = 'category-tab active';
                    allTab.textContent = 'All';
                    allTab.dataset.category = 'all';
                    allTab.addEventListener('click', () => {
                        document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                        allTab.classList.add('active');
                        currentCategoryFilter = 'all';
                        filterProductsByCategory();
                    });
                    categoryTabs.appendChild(allTab);
                    
                    // Add category tabs
                    if (categories) {
                        Object.values(categories).forEach(category => {
                            const categoryTab = document.createElement('div');
                            categoryTab.className = 'category-tab';
                            categoryTab.textContent = category;
                            categoryTab.dataset.category = category;
                            categoryTab.addEventListener('click', () => {
                                document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                                categoryTab.classList.add('active');
                                currentCategoryFilter = category;
                                filterProductsByCategory();
                            });
                            categoryTabs.appendChild(categoryTab);
                        });
                    }
                });
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        // Only show products with stock > 0 or no stock tracking
                        if (product.stock === undefined || product.stock > 0) {
                            const productCard = document.createElement('div');
                            productCard.className = 'pos-product-card';
                            productCard.dataset.category = product.category || 'Uncategorized';
                            productCard.innerHTML = `
                                <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                <h3>${product.name}</h3>
                                <p>MVR ${product.price?.toFixed(2) || '0.00'}</p>
                                ${product.stock !== undefined ? `<small>Stock: ${product.stock}</small>` : ''}
                            `;
                            productCard.addEventListener('click', () => {
                                if (currentOrderType === 'dining' && !currentTable) {
                                    showNotification('Please select a table first', 'error');
                                    return;
                                }
                                
                                if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                                    showNotification('Please select a credit customer first', 'error');
                                    return;
                                }
                                
                                // MODIFIED: Directly add product to cart with quantity 1
                                addToCartDirect(id, product);
                            });
                            posProducts.appendChild(productCard);
                        }
                    });
                }
            });
        }

        // NEW: Directly add product to cart
        function addToCartDirect(productId, product) {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                // Check stock if available
                if (product.stock !== undefined && existingItem.quantity + 1 > product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                // Check if product has stock
                if (product.stock !== undefined && product.stock < 1) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCart();
            showNotification(`${product.name} added to cart`);
        }

        // NEW: Show quantity input modal
        function showQuantityModal(productId, product) {
            selectedProductForQuantity = { id: productId, product: product };
            quantityProductName.textContent = `Enter quantity for ${product.name}`;
            quantityInput.value = '1';
            quantityInput.focus();
            quantityModal.style.display = 'flex';
        }

        // NEW: Add to cart with specified quantity
        function addToCartWithQuantity(productId, product, quantity) {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (product.stock !== undefined && existingItem.quantity + quantity > product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                // Check if product has stock
                if (product.stock !== undefined && product.stock < quantity) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            updateCart();
            showNotification(`${quantity} x ${product.name} added to cart`);
        }

        // NEW: Filter products by category
        function filterProductsByCategory() {
            const productCards = document.querySelectorAll('.pos-product-card');
            
            productCards.forEach(card => {
                if (currentCategoryFilter === 'all' || card.dataset.category === currentCategoryFilter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // NEW: Send order to credit management
        function sendToCreditManagement() {
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            if (!currentCustomerId || currentCustomerId === 'cash') {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            const orderNumber = generateOrderNumber();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Check if credit payment exceeds credit limit
            database.ref('creditAccounts/' + currentCustomerId).once('value').then(snapshot => {
                const creditAccount = snapshot.val();
                const currentBalance = creditAccount ? creditAccount.balance || 0 : 0;
                const creditLimit = currentCustomer.creditLimit || 0;
                
                if (currentBalance + total > creditLimit) {
                    showNotification('Credit limit exceeded. Please choose another payment method.', 'error');
                    return;
                }
                
                const order = {
                    orderNumber,
                    customer: {
                        id: currentCustomerId,
                        name: currentCustomer.name,
                        contact: currentCustomer.contact || ''
                    },
                    items: cart,
                    total,
                    paymentMethod: 'credit',
                    orderType: currentOrderType,
                    status: 'completed',
                    table: currentOrderType === 'dining' ? currentTable : null,
                    createdAt: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0]
                };
                
                // Save order
                database.ref('orders').push(order)
                    .then((ref) => {
                        const orderId = ref.key;
                        
                        // Update stock for each product
                        const updatePromises = cart.map(item => {
                            return database.ref('products/' + item.id).once('value').then(snapshot => {
                                const product = snapshot.val();
                                // Only update stock if it's being tracked
                                if (product.stock !== undefined) {
                                    const newStock = (product.stock || 0) - item.quantity;
                                    
                                    // Update product stock
                                    return database.ref('products/' + item.id).update({
                                        stock: newStock
                                    }).then(() => {
                                        // Record stock history
                                        return database.ref('stockHistory').push({
                                            productId: item.id,
                                            productName: product.name,
                                            type: 'sale',
                                            quantity: -item.quantity,
                                            previousStock: product.stock,
                                            newStock: newStock,
                                            orderId: orderId,
                                            notes: `Sale from order ${orderNumber}`,
                                            createdAt: new Date().toISOString()
                                        });
                                    });
                                }
                            });
                        });
                        
                        return Promise.all(updatePromises).then(() => {
                            // Update credit account
                            return database.ref('creditAccounts/' + currentCustomerId).once('value').then(snapshot => {
                                const creditAccount = snapshot.val() || {};
                                const newBalance = (creditAccount.balance || 0) + total;
                                
                                return database.ref('creditAccounts/' + currentCustomerId).set({
                                    customerId: currentCustomerId,
                                    customerName: currentCustomer.name,
                                    creditLimit: currentCustomer.creditLimit || 0,
                                    balance: newBalance,
                                    lastUpdated: new Date().toISOString()
                                }).then(() => {
                                    // Record credit transaction
                                    return database.ref('creditTransactions').push({
                                        customerId: currentCustomerId,
                                        customerName: currentCustomer.name,
                                        type: 'purchase',
                                        amount: total,
                                        balance: newBalance,
                                        orderId: orderId,
                                        orderNumber: orderNumber,
                                        createdAt: new Date().toISOString()
                                    });
                                });
                            });
                        }).then(() => {
                            // Free up the table if dining
                            if (currentOrderType === 'dining') {
                                database.ref('tables/' + currentTable).update({
                                    status: 'available'
                                });
                            }
                            
                            showNotification(`Order ${orderNumber} sent to credit management successfully`);
                            generateBill(order);
                            clearCart();
                            loadHeldOrders();
                            
                            // Reload dashboard data
                            loadDashboardData();
                        });
                    })
                    .catch(error => {
                        showNotification('Error sending to credit management: ' + error.message, 'error');
                    });
            });
        }

        // NEW: Add customer to table
        function addCustomerToTable(tableNumber, customerName) {
            if (!tableCustomers[tableNumber]) {
                tableCustomers[tableNumber] = [];
            }
            
            // Check if customer already exists for this table
            const existingCustomer = tableCustomers[tableNumber].find(c => c.name === customerName);
            if (existingCustomer) {
                showNotification('Customer already exists for this table', 'error');
                return;
            }
            
            const customerId = 'table-customer-' + Date.now();
            tableCustomers[tableNumber].push({
                id: customerId,
                name: customerName,
                table: tableNumber
            });
            
            updateTableCustomerList(tableNumber);
            showNotification(`Customer ${customerName} added to table ${tableNumber}`);
        }

        // NEW: Update table customer list
        function updateTableCustomerList(tableNumber) {
            tableCustomerList.innerHTML = '';
            
            if (tableCustomers[tableNumber] && tableCustomers[tableNumber].length > 0) {
                tableCustomers[tableNumber].forEach(customer => {
                    const customerItem = document.createElement('div');
                    customerItem.className = 'table-customer-item';
                    customerItem.innerHTML = `
                        <div class="table-customer-name">${customer.name}</div>
                        <div class="table-customer-actions">
                            <button class="btn btn-secondary select-customer" data-id="${customer.id}">Select</button>
                            <button class="btn btn-danger remove-customer" data-id="${customer.id}">Remove</button>
                        </div>
                    `;
                    tableCustomerList.appendChild(customerItem);
                });
                
                // Add event listeners
                document.querySelectorAll('.select-customer').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        selectTableCustomer(customerId);
                    });
                });
                
                document.querySelectorAll('.remove-customer').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        removeCustomerFromTable(tableNumber, customerId);
                    });
                });
            } else {
                tableCustomerList.innerHTML = '<p>No customers added to this table</p>';
            }
        }

        // NEW: Select table customer
        function selectTableCustomer(customerId) {
            if (!currentTable) return;
            
            const customer = tableCustomers[currentTable].find(c => c.id === customerId);
            if (customer) {
                currentTableCustomer = customer;
                document.getElementById('cashCustomerName').value = customer.name;
                showNotification(`Selected customer: ${customer.name}`);
                
                // Highlight selected customer
                document.querySelectorAll('.table-customer-item').forEach(item => {
                    item.style.backgroundColor = '';
                });
                document.querySelector(`.select-customer[data-id="${customerId}"]`).closest('.table-customer-item').style.backgroundColor = '#e9f7ef';
            }
        }

        // NEW: Remove customer from table
        function removeCustomerFromTable(tableNumber, customerId) {
            if (tableCustomers[tableNumber]) {
                tableCustomers[tableNumber] = tableCustomers[tableNumber].filter(c => c.id !== customerId);
                updateTableCustomerList(tableNumber);
                
                if (currentTableCustomer && currentTableCustomer.id === customerId) {
                    currentTableCustomer = null;
                    document.getElementById('cashCustomerName').value = '';
                }
                
                showNotification('Customer removed from table');
            }
        }

        // FIX: Load held orders with customer names - MODIFIED: Only load when clicking Load button
        function loadHeldOrders() {
            const customerFilter = heldOrderCustomerFilter.value.toLowerCase();
            
            database.ref('heldOrders').once('value').then(snapshot => {
                const orders = snapshot.val();
                heldOrdersTable.innerHTML = '';
                
                if (orders) {
                    Object.entries(orders).forEach(([orderNumber, order]) => {
                        // Apply customer name filter
                        if (customerFilter && !order.customer?.name?.toLowerCase().includes(customerFilter)) {
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        // FIX: Use customer name instead of "N/A"
                        const customerName = order.customer?.name || 'Unknown Customer';
                        row.innerHTML = `
                            <td>${orderNumber}</td>
                            <td>${customerName}</td>
                            <td>${order.table || 'N/A'}</td>
                            <td>${order.items.length} items</td>
                            <td>MVR ${order.total.toFixed(2)}</td>
                            <td>${new Date(order.createdAt).toLocaleTimeString()}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary load-held-order" data-order="${orderNumber}">Load</button>
                                <button class="btn btn-danger delete-held-order" data-order="${orderNumber}">Delete</button>
                            </td>
                        `;
                        heldOrdersTable.appendChild(row);
                    });
                    
                    // Add event listeners to load buttons
                    document.querySelectorAll('.load-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const orderNumber = btn.dataset.order;
                            loadHeldOrder(orderNumber);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const orderNumber = btn.dataset.order;
                            deleteHeldOrder(orderNumber);
                        });
                    });
                }
            });
        }

        // MODIFIED: Load held order - Only load when explicitly clicking Load button
        function loadHeldOrder(orderNumber) {
            database.ref('heldOrders/' + orderNumber).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order) {
                    // Set order type
                    if (order.orderType === 'dining') {
                        diningBtn.click();
                        if (order.table) {
                            selectTable(order.table);
                        }
                    } else {
                        takeawayBtn.click();
                    }
                    
                    // Set customer name
                    if (order.customer && order.customer.name) {
                        document.getElementById('cashCustomerName').value = order.customer.name;
                    }
                    
                    // Load items to cart
                    cart = order.items;
                    updateCart();
                    
                    showNotification(`Loaded held order ${orderNumber}`);
                    
                    // Delete the held order after loading
                    deleteHeldOrder(orderNumber);
                }
            });
        }

        // MODIFIED: Select table - No longer automatically loads held orders
        function selectTable(tableNumber) {
            // Deselect all tables
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Select the clicked table
            const tableBtn = document.querySelector(`.table-btn[data-table="${tableNumber}"]`);
            tableBtn.classList.add('active');
            
            currentTable = tableNumber;
            currentTableCustomer = null;
            
            // Initialize table customers if not exists
            if (!tableCustomers[tableNumber]) {
                tableCustomers[tableNumber] = [];
            }
            
            // Update table customer list
            updateTableCustomerList(tableNumber);
            
            // REMOVED: Automatic loading of held orders for this table
            // Now held orders are only loaded when explicitly clicking the Load button
        }

        // Handle login
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            database.ref('adminUsers').once('value').then(snapshot => {
                const users = snapshot.val();
                let authenticated = false;
                
                if (users) {
                    Object.entries(users).forEach(([id, user]) => {
                        if (user.username === username && user.password === password) {
                            authenticated = true;
                            currentUser = { id, ...user };
                            userAccess = user.access || [];
                            
                            // Save to localStorage
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            
                            showAdminPanel();
                            updateUserInterface();
                            loadDashboardData();
                            loadProducts();
                            loadCategories();
                            loadOrders();
                            loadStock();
                            loadCustomers();
                            loadCreditAccounts();
                            loadExpenses();
                            loadStoreSettings();
                            loadHeldOrders();
                            loadTables();
                            
                            // Set up real-time listeners
                            setupRealtimeListeners();
                        }
                    });
                }
                
                if (!authenticated) {
                    showNotification('Invalid username or password', 'error');
                }
            }).catch(error => {
                showNotification('Error during login: ' + error.message, 'error');
            });
        }

        // Create new user
        function createUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            
            // Get access controls
            const access = [];
            document.querySelectorAll('input[name="access"]:checked').forEach(checkbox => {
                access.push(checkbox.value);
            });
            
            const newUser = {
                username,
                password,
                role,
                access,
                createdAt: new Date().toISOString()
            };
            
            database.ref('adminUsers').push(newUser)
                .then(() => {
                    showNotification('User created successfully!');
                    createUserForm.reset();
                    loadUsers();
                })
                .catch(error => {
                    showNotification('Error creating user: ' + error.message, 'error');
                });
        }

        // Load users for owner modal
        function loadUsers() {
            database.ref('adminUsers').once('value').then(snapshot => {
                const users = snapshot.val();
                const userListContainer = document.getElementById('userListContainer');
                userListContainer.innerHTML = '';
                
                if (users) {
                    Object.entries(users).forEach(([id, user]) => {
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <div class="user-info">
                                <h3>${user.username}</h3>
                                <p>Role: ${user.role} | Access: ${user.access.join(', ')}</p>
                                <p>Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-danger delete-user" data-id="${id}">Delete</button>
                            </div>
                        `;
                        userListContainer.appendChild(userCard);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-user').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const userId = btn.dataset.id;
                            deleteUser(userId);
                        });
                    });
                }
            });
        }

        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                database.ref('adminUsers/' + userId).remove()
                    .then(() => {
                        showNotification('User deleted successfully!');
                        loadUsers();
                    })
                    .catch(error => {
                        showNotification('Error deleting user: ' + error.message, 'error');
                    });
            }
        }

        // Update user interface based on access
        function updateUserInterface() {
            // Update user info in header
            currentUserInfo.textContent = `Logged in as: ${currentUser.username} (${currentUser.role})`;
            
            // Hide sidebar items based on access
            sidebarLinks.forEach(link => {
                const tab = link.dataset.tab;
                if (tab !== 'dashboard' && !userAccess.includes(tab)) {
                    link.style.display = 'none';
                } else {
                    link.style.display = 'flex';
                }
            });
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            userAccess = [];
            showLoginScreen();
        }

        // Show login screen
        function showLoginScreen() {
            loginScreen.style.display = 'flex';
            adminPanel.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Show admin panel
        function showAdminPanel() {
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'flex';
        }

        // Switch between main tabs
        function switchTab(tab) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
            
            // Update header title
            document.querySelector('.header h1').textContent = getTabTitle(tab);
            
            // Load specific data for certain tabs
            if (tab === 'pos') {
                loadProductsForPOS();
                loadCustomersForPOS();
                loadHeldOrders();
                loadTables();
            } else if (tab === 'stock') {
                loadStock();
            } else if (tab === 'customers') {
                loadCustomers();
            } else if (tab === 'credit') {
                loadCreditAccounts();
            } else if (tab === 'expenses') {
                loadExpenses();
            } else if (tab === 'documents') {
                loadDocuments();
                loadCustomersForDocuments();
                loadProductsForDocuments();
            }
        }

        // Switch between sub-tabs
        function switchSubTab(subtab) {
            subtabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subtab).classList.add('active');
            
            // Load specific data for sub-tabs
            if (subtab === 'stock-history') {
                loadStockHistory();
            } else if (subtab === 'credit-transactions') {
                loadCreditTransactions();
            } else if (subtab === 'credit-orders') {
                loadCreditOrders();
            } else if (subtab === 'expense-list') {
                loadExpenses();
            } else if (subtab === 'document-list') {
                loadDocuments();
            }
        }

        // Get tab title
        function getTabTitle(tab) {
            const titles = {
                'dashboard': 'ޑޭޝްބޯޑް',
                'pos': 'ވިއްކުމުގެ ނިޒާމް',
                'products': 'ޕްރޮޑަކްޓް މެނޭޖްމަންޓް',
                'categories': 'ބާވަތްތައް ބެލެހެއްޓުން',
                'stock': 'ސްޓޮކް ބެލެހެއްޓުން',
                'customers': 'ކަސްޓަމާސް',
                'credit': 'ކްރެޑިޓް ބެލެހެއްޓުން',
                'expenses': 'ޚަރަދުތައް ބެލެހެއްޓުން',
                'documents': 'ޑޮކިއުމެންސް ބެލެހެއްޓުން',
                'settings': 'ސެޓިން'
            };
            return titles[tab] || 'ޕްރޮޑަކްޓް ބެލެހެއްޓުން';
        }

        // Set up real-time listeners for new orders
        function setupRealtimeListeners() {
            // Listen for new orders (only show notification for new orders)
            database.ref('orders').orderByChild('createdAt').on('child_added', (snapshot) => {
                const order = snapshot.val();
                const orderId = snapshot.key;
                
                // Only show notification if this is a new order that hasn't been notified yet
                if (!notifiedOrders[orderId] && order.status === 'pending') {
                    notifiedOrders[orderId] = true;
                    showNotification(`New order received: ${order.orderNumber} from ${order.customer?.name || 'Unknown'}`, 'success');
                }
                
                loadDashboardData();
                loadOrders();
            });
        }
  // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'notification-error' : type === 'warning' ? 'notification-warning' : ''}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
                <button class="close-notification"><i class="fas fa-times"></i></button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Add event listener to close button
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load dashboard data
        function loadDashboardData() {
            // Load orders count
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const ordersCount = orders ? Object.keys(orders).length : 0;
                document.getElementById('totalOrders').textContent = ordersCount;
                
                // Calculate total revenue
                let totalRevenue = 0;
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if (order.status !== 'cancelled') {
                            totalRevenue += order.total || 0;
                        }
                    });
                }
                document.getElementById('totalRevenue').textContent = `MVR ${totalRevenue.toFixed(2)}`;
                document.getElementById('revenueValue').textContent = `MVR ${totalRevenue.toFixed(2)}`;
            });
            
            // Load customers count
            database.ref('customers').once('value').then(snapshot => {
                const customers = snapshot.val();
                const customersCount = customers ? Object.keys(customers).length : 0;
                document.getElementById('totalCustomers').textContent = customersCount;
                
                // Count credit customers
                let creditCustomersCount = 0;
                if (customers) {
                    Object.values(customers).forEach(customer => {
                        if (customer.creditLimit > 0) {
                            creditCustomersCount++;
                        }
                    });
                }
                document.getElementById('creditCustomersCount').textContent = creditCustomersCount;
            });
            
            // Load held orders count
            database.ref('heldOrders').once('value').then(snapshot => {
                const heldOrders = snapshot.val();
                const heldOrdersCount = heldOrders ? Object.keys(heldOrders).length : 0;
                document.getElementById('heldOrdersCount').textContent = heldOrdersCount;
            });
            
            // Load expenses and calculate net profit/loss
            database.ref('expenses').once('value').then(snapshot => {
                const expenses = snapshot.val();
                let totalExpenses = 0;
                
                if (expenses) {
                    Object.values(expenses).forEach(expense => {
                        totalExpenses += expense.amount || 0;
                    });
                }
                
                document.getElementById('totalExpenses').textContent = `MVR ${totalExpenses.toFixed(2)}`;
                document.getElementById('expensesValue').textContent = `MVR ${totalExpenses.toFixed(2)}`;
                
                // Calculate net profit/loss (revenue - expenses)
                database.ref('orders').once('value').then(ordersSnapshot => {
                    const orders = ordersSnapshot.val();
                    let totalRevenue = 0;
                    
                    if (orders) {
                        Object.values(orders).forEach(order => {
                            if (order.status !== 'cancelled') {
                                totalRevenue += order.total || 0;
                            }
                        });
                    }
                    
                    const netProfit = totalRevenue - totalExpenses;
                    const netProfitElement = document.getElementById('netProfit');
                    netProfitElement.textContent = `MVR ${netProfit.toFixed(2)}`;
                    document.getElementById('profitValue').textContent = `MVR ${netProfit.toFixed(2)}`;
                    
                    // Set color based on profit/loss - FIXED: Always show red for loss
                    if (netProfit >= 0) {
                        netProfitElement.className = 'profit';
                        document.getElementById('profitChange').className = 'financial-change positive';
                    } else {
                        netProfitElement.className = 'loss';
                        document.getElementById('profitChange').className = 'financial-change negative';
                    }
                    
                    // Update profit/loss chart
                    updateProfitLossChart(totalRevenue, totalExpenses, netProfit);
                    
                    // Update financial trends
                    updateFinancialTrends(totalRevenue, totalExpenses, netProfit);
                });
            });
            
            // Load balance sheet
            loadBalanceSheet();
        }

        // Update profit/loss chart
        function updateProfitLossChart(revenue, expenses, profit) {
            const ctx = document.getElementById('profitLossChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (profitLossChart) {
                profitLossChart.destroy();
            }
            
            profitLossChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Revenue', 'Expenses', 'Net Profit/Loss'],
                    datasets: [{
                        data: [revenue, expenses, Math.abs(profit)],
                        backgroundColor: [
                            '#4a9e5b',
                            '#dc3545',
                            profit >= 0 ? '#4a9e5b' : '#dc3545'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': MVR ' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update financial trends
        function updateFinancialTrends(revenue, expenses, profit) {
            // Generate sample trend data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonth = new Date().getMonth();
            const displayMonths = months.slice(Math.max(0, currentMonth - 5), currentMonth + 1);
            
            // Generate trend data
            const revenueData = Array.from({length: displayMonths.length}, () => Math.floor(Math.random() * 10000) + 5000);
            const expensesData = Array.from({length: displayMonths.length}, () => Math.floor(Math.random() * 8000) + 3000);
            const profitData = revenueData.map((val, idx) => val - expensesData[idx]);
            
            // Update revenue trend
            const revenueCtx = document.getElementById('revenueTrend').getContext('2d');
            if (revenueTrendChart) revenueTrendChart.destroy();
            revenueTrendChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: displayMonths,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#4a9e5b',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
            
            // Update expenses trend
            const expensesCtx = document.getElementById('expensesTrend').getContext('2d');
            if (expensesTrendChart) expensesTrendChart.destroy();
            expensesTrendChart = new Chart(expensesCtx, {
                type: 'line',
                data: {
                    labels: displayMonths,
                    datasets: [{
                        label: 'Expenses',
                        data: expensesData,
                        borderColor: '#dc3545',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
            
            // Update profit trend
            const profitCtx = document.getElementById('profitTrend').getContext('2d');
            if (profitTrendChart) profitTrendChart.destroy();
            profitTrendChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: displayMonths,
                    datasets: [{
                        label: 'Profit',
                        data: profitData,
                        borderColor: profit >= 0 ? '#4a9e5b' : '#dc3545',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
            
            // Update percentage changes
            document.getElementById('revenueChange').textContent = `+${Math.floor(Math.random() * 20) + 5}% ފާއިތުވި މަހުން`;
            document.getElementById('expensesChange').textContent = `${Math.floor(Math.random() * 10) + 1}% ފާއިތުވި މަހުން`;
            document.getElementById('profitChange').textContent = `${profit >= 0 ? '+' : ''}${Math.floor(Math.random() * 25) + 8}% from last month`;
        }

        // Load balance sheet
        function loadBalanceSheet() {
            const dateFrom = document.getElementById('balanceDateFrom').value;
            const dateTo = document.getElementById('balanceDateTo').value;
            
            // Get revenue
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                let totalRevenue = 0;
                
                if (orders) {
                    Object.values(orders).forEach(order => {
                        // Apply date filter
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        if (order.status !== 'cancelled') {
                            totalRevenue += order.total || 0;
                        }
                    });
                }
                
                // Get expenses
                database.ref('expenses').once('value').then(expensesSnapshot => {
                    const expenses = expensesSnapshot.val();
                    let totalExpenses = 0;
                    
                    if (expenses) {
                        Object.values(expenses).forEach(expense => {
                            // Apply date filter
                            if (dateFrom && expense.date < dateFrom) return;
                            if (dateTo && expense.date > dateTo) return;
                            
                            totalExpenses += expense.amount || 0;
                        });
                    }
                    
                    const netProfit = totalRevenue - totalExpenses;
                    
                    // Update balance sheet
                    const balanceSheet = document.getElementById('balanceSheet');
                    balanceSheet.innerHTML = `
                        <div class="balance-row">
                            <span>Total Revenue</span>
                            <span>MVR ${totalRevenue.toFixed(2)}</span>
                        </div>
                        <div class="balance-row">
                            <span>Total Expenses</span>
                            <span class="expense-color">MVR ${totalExpenses.toFixed(2)}</span>
                        </div>
                        <div class="balance-row total">
                            <span>Net ${netProfit >= 0 ? 'Profit' : 'Loss'}</span>
                            <span class="${netProfit >= 0 ? 'profit' : 'loss'}">MVR ${Math.abs(netProfit).toFixed(2)}</span>
                        </div>
                    `;
                });
            });
        }

        // Load tables
        function loadTables() {
            database.ref('tables').once('value').then(snapshot => {
                const tables = snapshot.val();
                tableGrid.innerHTML = '';
                
                // Create table buttons
                for (let i = 1; i <= tablesCount; i++) {
                    const tableBtn = document.createElement('div');
                    tableBtn.className = 'table-btn';
                    tableBtn.textContent = i;
                    tableBtn.dataset.table = i;
                    
                    // Check if table is occupied
                    if (tables && tables[i] && tables[i].status === 'occupied') {
                        tableBtn.classList.add('occupied');
                    }
                    
                    tableBtn.addEventListener('click', () => {
                        selectTable(i);
                    });
                    
                    tableGrid.appendChild(tableBtn);
                }
            });
        }

        // Select table - MODIFIED: No longer automatically loads held orders
        function selectTable(tableNumber) {
            // Deselect all tables
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Select the clicked table
            const tableBtn = document.querySelector(`.table-btn[data-table="${tableNumber}"]`);
            tableBtn.classList.add('active');
            
            currentTable = tableNumber;
            currentTableCustomer = null;
            
            // Initialize table customers if not exists
            if (!tableCustomers[tableNumber]) {
                tableCustomers[tableNumber] = [];
            }
            
            // Update table customer list
            updateTableCustomerList(tableNumber);
            
            // REMOVED: Automatic loading of held orders for this table
            // Now held orders are only loaded when explicitly clicking the Load button
        }

        // Load customers for POS
        function loadCustomersForPOS() {
            if (!userAccess.includes('pos')) return;
            
            database.ref('customers').once('value').then(snapshot => {
                const customers = snapshot.val();
                creditCustomerGrid.innerHTML = '';
                
                if (customers) {
                    Object.entries(customers).forEach(([id, customer]) => {
                        if (customer.creditLimit > 0) {
                            const customerItem = document.createElement('div');
                            customerItem.className = 'customer-item';
                            customerItem.dataset.customerId = id;
                            customerItem.innerHTML = `
                                <div>${customer.name}</div>
                                <div class="customer-credit">Credit: MVR ${customer.creditLimit.toFixed(2)}</div>
                            `;
                            customerItem.addEventListener('click', () => {
                                selectCreditCustomer(id, customer);
                            });
                            creditCustomerGrid.appendChild(customerItem);
                        }
                    });
                }
            });
        }

        // Select credit customer
        function selectCreditCustomer(customerId, customer) {
            // Deselect all credit customers
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Select the clicked customer
            const customerItem = document.querySelector(`.customer-item[data-customer-id="${customerId}"]`);
            customerItem.classList.add('active');
            
            currentCustomerId = customerId;
            currentCustomer = customer;
            
            // Load credit balance
            database.ref('creditAccounts/' + customerId).once('value').then(snapshot => {
                const creditAccount = snapshot.val();
                const balance = creditAccount ? creditAccount.balance || 0 : 0;
                const remainingCredit = customer.creditLimit - balance;
                
                creditBalanceInfo.innerHTML = `
                    Current Balance: MVR ${balance.toFixed(2)}<br>
                    Remaining Credit: MVR ${remainingCredit.toFixed(2)}
                `;
            });
        }

        // Update cart display
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">No items added yet</p>';
                cartTotal.textContent = 'Total: MVR 0.00';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div>${item.name}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease-btn" data-index="${index}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase-btn" data-index="${index}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        MVR ${itemTotal.toFixed(2)}
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `Total: MVR ${total.toFixed(2)}`;
            
            // Add event listeners to quantity buttons
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    decreaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    increaseQuantity(index);
                });
            });
        }

        // Decrease item quantity
        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // Increase item quantity
        function increaseQuantity(index) {
            // Check product stock
            const productId = cart[index].id;
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                if (product.stock !== undefined && cart[index].quantity >= product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart[index].quantity++;
                updateCart();
            });
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCart();
        }

        // Hold order
        function holdOrder() {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            // For dining orders, use table customer if available
            let customerName = '';
            if (currentOrderType === 'dining' && currentTableCustomer) {
                customerName = currentTableCustomer.name;
            } else {
                customerName = document.getElementById('cashCustomerName').value;
            }
            
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            const orderNumber = generateOrderNumber();
            const order = {
                orderNumber,
                customer: { name: customerName },
                items: [...cart],
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                status: 'held',
                orderType: currentOrderType,
                table: currentOrderType === 'dining' ? currentTable : null,
                createdAt: new Date().toISOString()
            };
            
            database.ref('heldOrders/' + orderNumber).set(order)
                .then(() => {
                    showNotification(`Order ${orderNumber} held successfully`);
                    clearCart();
                    loadHeldOrders();
                    
                    // Mark table as occupied if dining
                    if (currentOrderType === 'dining') {
                        database.ref('tables/' + currentTable).set({
                            status: 'occupied',
                            orderNumber: orderNumber
                        });
                    }
                })
                .catch(error => {
                    showNotification('Error holding order: ' + error.message, 'error');
                });
        }

        // Load held order - MODIFIED: Only loads when explicitly clicking Load button
        function loadHeldOrder(orderNumber) {
            database.ref('heldOrders/' + orderNumber).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order) {
                    // Set order type
                    if (order.orderType === 'dining') {
                        diningBtn.click();
                        if (order.table) {
                            selectTable(order.table);
                        }
                    } else {
                        takeawayBtn.click();
                    }
                    
                    // Set customer name
                    if (order.customer && order.customer.name) {
                        document.getElementById('cashCustomerName').value = order.customer.name;
                    }
                    
                    // Load items to cart
                    cart = order.items;
                    updateCart();
                    
                    showNotification(`Loaded held order ${orderNumber}`);
                    
                    // Delete the held order after loading
                    deleteHeldOrder(orderNumber);
                }
            });
        }

        // Delete held order
        function deleteHeldOrder(orderNumber) {
            database.ref('heldOrders/' + orderNumber).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order && order.table) {
                    // Free up the table
                    database.ref('tables/' + order.table).update({
                        status: 'available'
                    });
                }
                
                database.ref('heldOrders/' + orderNumber).remove()
                    .then(() => {
                        showNotification('Held order deleted');
                        loadHeldOrders();
                    })
                    .catch(error => {
                        showNotification('Error deleting held order: ' + error.message, 'error');
                    });
            });
        }

        // Complete order
        function completeOrder() {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            // Fixed the selector - use double quotes inside single quotes or escape the inner quotes
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const orderNumber = generateOrderNumber();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // For dining orders, use table customer if available
            let customerName = '';
            if (currentOrderType === 'dining' && currentTableCustomer) {
                customerName = currentTableCustomer.name;
            } else {
                customerName = document.getElementById('cashCustomerName').value;
            }
            
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            // Check if credit payment exceeds credit limit
            if (paymentMethod === 'credit' && currentCustomerId !== 'cash') {
                database.ref('creditAccounts/' + currentCustomerId).once('value').then(snapshot => {
                    const creditAccount = snapshot.val();
                    const currentBalance = creditAccount ? creditAccount.balance || 0 : 0;
                    const creditLimit = currentCustomer.creditLimit || 0;
                    
                    if (currentBalance + total > creditLimit) {
                        showNotification('Credit limit exceeded. Please choose another payment method.', 'error');
                        return;
                    }
                    
                    processOrder(orderNumber, total, paymentMethod, customerName);
                });
            } else {
                processOrder(orderNumber, total, paymentMethod, customerName);
            }
        }

        // Process order
        function processOrder(orderNumber, total, paymentMethod, customerName) {
            const order = {
                orderNumber,
                customer: { 
                    name: customerName,
                    // Store customer ID for credit orders to enable filtering
                    id: (paymentMethod === 'credit' && currentCustomerId !== 'cash') ? currentCustomerId : null
                },
                items: cart,
                total,
                paymentMethod,
                orderType: currentOrderType,
                status: paymentMethod === 'credit' ? 'completed' : 'pending',
                table: currentOrderType === 'dining' ? currentTable : null,
                createdAt: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };
            
            // Save order
            database.ref('orders').push(order)
                .then((ref) => {
                    const orderId = ref.key;
                    
                    // Update stock for each product
                    const updatePromises = cart.map(item => {
                        return database.ref('products/' + item.id).once('value').then(snapshot => {
                            const product = snapshot.val();
                            // Only update stock if it's being tracked
                            if (product.stock !== undefined) {
                                const newStock = (product.stock || 0) - item.quantity;
                                
                                // Update product stock
                                return database.ref('products/' + item.id).update({
                                    stock: newStock
                                }).then(() => {
                                    // Record stock history
                                    return database.ref('stockHistory').push({
                                        productId: item.id,
                                        productName: product.name,
                                        type: 'sale',
                                        quantity: -item.quantity,
                                        previousStock: product.stock,
                                        newStock: newStock,
                                        orderId: orderId,
                                        notes: `Sale from order ${orderNumber}`,
                                        createdAt: new Date().toISOString()
                                    });
                                });
                            }
                        });
                    });
                    
                    return Promise.all(updatePromises).then(() => {
                        // If credit payment, update credit account
                        if (paymentMethod === 'credit' && currentCustomerId !== 'cash') {
                            return database.ref('creditAccounts/' + currentCustomerId).once('value').then(snapshot => {
                                const creditAccount = snapshot.val() || {};
                                const newBalance = (creditAccount.balance || 0) + total;
                                
                                return database.ref('creditAccounts/' + currentCustomerId).set({
                                    customerId: currentCustomerId,
                                    customerName: currentCustomer.name,
                                    creditLimit: currentCustomer.creditLimit || 0,
                                    balance: newBalance,
                                    lastUpdated: new Date().toISOString()
                                }).then(() => {
                                    // Record credit transaction
                                    return database.ref('creditTransactions').push({
                                        customerId: currentCustomerId,
                                        customerName: currentCustomer.name,
                                        type: 'purchase',
                                        amount: total,
                                        balance: newBalance,
                                        orderId: orderId,
                                        orderNumber: orderNumber,
                                        createdAt: new Date().toISOString()
                                    });
                                });
                            });
                        }
                    }).then(() => {
                        // Free up the table if dining
                        if (currentOrderType === 'dining') {
                            database.ref('tables/' + currentTable).update({
                                status: 'available'
                            });
                        }
                        
                        showNotification(`Order ${orderNumber} completed successfully`);
                        generateBill(order);
                        clearCart();
                        loadHeldOrders();
                        
                        // Reload dashboard data
                        loadDashboardData();
                    });
                })
                .catch(error => {
                    showNotification('Error completing order: ' + error.message, 'error');
                });
        }

        // Generate order number
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().substr(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `ORD-${year}${month}${day}-${random}`;
        }

        // Generate bill
        function generateBill(order) {
            const billModalBody = document.getElementById('billModalBody');
            let billHTML = `
                <div class="bill-container">
                    <div class="bill-header">
                        <h2>${document.getElementById('storeName').value || 'symcodermv-cafe'}</h2>
                        <p>${document.getElementById('storeAddress').value || ''}</p>
                        <p>Tel: ${document.getElementById('storePhone').value || ''}</p>
                        <p>Order #: ${order.orderNumber}</p>
                        <p>Date: ${new Date().toLocaleString()}</p>
                        <p>Customer: ${order.customer?.name || 'Cash Customer'}</p>
                        ${order.table ? `<p>Table: ${order.table}</p>` : ''}
                        <div class="order-type-badge">${order.orderType === 'dining' ? 'DINING' : 'TAKEAWAY'}</div>
                    </div>
                    <div class="bill-items">
            `;
            
            order.items.forEach(item => {
                billHTML += `
                    <div class="bill-item">
                        <div>${item.name} x ${item.quantity}</div>
                        <div>MVR ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            });
            
            billHTML += `
                    </div>
                    <div class="bill-total">
                        Total: MVR ${order.total.toFixed(2)}
                    </div>
                    <div class="payment-method">
                        Payment Method: ${order.paymentMethod === 'cash' ? 'Cash' : order.paymentMethod === 'credit' ? 'Credit' : 'Bank Transfer'}
                    </div>
                    <div class="thank-you">
                        <p>Thank you for your business!</p>
                    </div>
                </div>
            `;
            
            billModalBody.innerHTML = billHTML;
            billModal.style.display = 'block';
        }

        // Print bill
        function printBill() {
            const printContent = document.getElementById('billModalBody').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reinitialize event listeners
            initAdmin();
        }

        // Load expenses
        function loadExpenses() {
            if (!userAccess.includes('expenses')) return;
            
            const dateFrom = document.getElementById('expenseDateFrom').value;
            const dateTo = document.getElementById('expenseDateTo').value;
            
            database.ref('expenses').once('value').then(snapshot => {
                const expenses = snapshot.val();
                const expensesTable = document.getElementById('expensesTable').querySelector('tbody');
                const expensesTableFooter = document.getElementById('expensesTableFooter');
                expensesTable.innerHTML = '';
                expensesTableFooter.innerHTML = '';
                
                let totalAmount = 0;
                let expenseCount = 0;
                
                if (expenses) {
                    Object.entries(expenses).forEach(([id, expense]) => {
                        // Apply date filter
                        if (dateFrom && expense.date < dateFrom) return;
                        if (dateTo && expense.date > dateTo) return;
                        
                        const amount = expense.amount || 0;
                        totalAmount += amount;
                        expenseCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${expense.date}</td>
                            <td>${expense.supplier}</td>
                            <td>${expense.invoice || 'N/A'}</td>
                            <td class="expense-color">MVR ${amount.toFixed(2)}</td>
                            <td>${expense.notes || 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger delete-expense" data-id="${id}">Delete</button>
                            </td>
                        `;
                        expensesTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (expenseCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td colspan="3">Subtotal (${expenseCount} expenses)</td>
                            <td class="expense-color">MVR ${totalAmount.toFixed(2)}</td>
                            <td colspan="2"></td>
                        `;
                        expensesTableFooter.appendChild(footerRow);
                    }
                }
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-expense').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const expenseId = btn.dataset.id;
                        if (confirm('Are you sure you want to delete this expense?')) {
                            deleteExpense(expenseId);
                        }
                    });
                });
            });
        }

        // Add expense
        function addExpense(e) {
            e.preventDefault();
            
            const expense = {
                date: document.getElementById('expenseDate').value,
                supplier: document.getElementById('expenseSupplier').value,
                invoice: document.getElementById('expenseInvoice').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                notes: document.getElementById('expenseNotes').value,
                createdAt: new Date().toISOString()
            };
            
            database.ref('expenses').push(expense)
                .then(() => {
                    showNotification('Expense added successfully!');
                    document.getElementById('addExpenseForm').reset();
                    loadExpenses();
                    loadDashboardData();
                })
                .catch(error => {
                    showNotification('Error adding expense: ' + error.message, 'error');
                });
        }

        // Delete expense
        function deleteExpense(expenseId) {
            database.ref('expenses/' + expenseId).remove()
                .then(() => {
                    showNotification('Expense deleted successfully!');
                    loadExpenses();
                    loadDashboardData();
                })
                .catch(error => {
                    showNotification('Error deleting expense: ' + error.message, 'error');
                });
        }

        // Load customers for documents
        function loadCustomersForDocuments() {
            database.ref('customers').once('value').then(snapshot => {
                const customers = snapshot.val();
                const quotationCustomer = document.getElementById('quotationCustomer');
                const invoiceCustomer = document.getElementById('invoiceCustomer');
                
                quotationCustomer.innerHTML = '<option value="">Select Customer</option>';
                invoiceCustomer.innerHTML = '<option value="">Select Customer</option>';
                
                if (customers) {
                    Object.entries(customers).forEach(([id, customer]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = customer.name;
                        quotationCustomer.appendChild(option.cloneNode(true));
                        invoiceCustomer.appendChild(option);
                    });
                }
            });
        }

        // Load products for documents
        function loadProductsForDocuments() {
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const quotationProduct = document.getElementById('quotationProduct');
                const invoiceProduct = document.getElementById('invoiceProduct');
                
                quotationProduct.innerHTML = '<option value="">Select Product</option>';
                invoiceProduct.innerHTML = '<option value="">Select Product</option>';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = product.name;
                        option.dataset.price = product.price;
                        quotationProduct.appendChild(option.cloneNode(true));
                        invoiceProduct.appendChild(option);
                    });
                }
            });
        }

        // Add quotation item to table
        function addQuotationItemToTable() {
            const productId = document.getElementById('quotationProduct').value;
            const quantity = parseInt(document.getElementById('quotationQuantity').value) || 1;
            
            if (!productId) {
                showNotification('Please select a product', 'error');
                return;
            }
            
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                const quotationItemsTable = document.getElementById('quotationItemsTable').querySelector('tbody');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${quantity}</td>
                    <td>MVR ${product.price.toFixed(2)}</td>
                    <td>MVR ${(product.price * quantity).toFixed(2)}</td>
                    <td><button class="btn btn-danger remove-item">Remove</button></td>
                `;
                row.querySelector('.remove-item').addEventListener('click', () => {
                    row.remove();
                });
                
                quotationItemsTable.appendChild(row);
                
                // Clear selection
                document.getElementById('quotationProduct').value = '';
                document.getElementById('quotationQuantity').value = '1';
            });
        }

        // Add invoice item to table
        function addInvoiceItemToTable() {
            const productId = document.getElementById('invoiceProduct').value;
            const quantity = parseInt(document.getElementById('invoiceQuantity').value) || 1;
            
            if (!productId) {
                showNotification('Please select a product', 'error');
                return;
            }
            
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                const invoiceItemsTable = document.getElementById('invoiceItemsTable').querySelector('tbody');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${quantity}</td>
                    <td>MVR ${product.price.toFixed(2)}</td>
                    <td>MVR ${(product.price * quantity).toFixed(2)}</td>
                    <td><button class="btn btn-danger remove-item">Remove</button></td>
                `;
                row.querySelector('.remove-item').addEventListener('click', () => {
                    row.remove();
                });
                
                invoiceItemsTable.appendChild(row);
                
                // Clear selection
                document.getElementById('invoiceProduct').value = '';
                document.getElementById('invoiceQuantity').value = '1';
            });
        }

        // Generate quotation
        function generateQuotation(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('quotationCustomer').value;
            const date = document.getElementById('quotationDate').value;
            const validUntil = document.getElementById('quotationValidUntil').value;
            const quotationNumber = document.getElementById('quotationNumber').value;
            const notes = document.getElementById('quotationNotes').value;
            
            if (!customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }
            
            const quotationItems = [];
            let total = 0;
            
            document.querySelectorAll('#quotationItemsTable tbody tr').forEach(row => {
                const cells = row.cells;
                const item = {
                    product: cells[0].textContent,
                    quantity: parseInt(cells[1].textContent),
                    price: parseFloat(cells[2].textContent.replace('MVR', '')),
                    total: parseFloat(cells[3].textContent.replace('MVR', ''))
                };
                quotationItems.push(item);
                total += item.total;
            });
            
            if (quotationItems.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }
            
            database.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                
                const quotation = {
                    number: quotationNumber,
                    date,
                    validUntil,
                    customer: {
                        id: customerId,
                        name: customer.name,
                        contact: customer.contact,
                        address: customer.address
                    },
                    items: quotationItems,
                    total,
                    notes,
                    createdAt: new Date().toISOString()
                };
                
                database.ref('quotations').push(quotation)
                    .then(() => {
                        showNotification('Quotation generated successfully!');
                        previewDocument('quotation', quotation);
                        document.getElementById('quotationForm').reset();
                        document.getElementById('quotationItemsTable').querySelector('tbody').innerHTML = '';
                    })
                    .catch(error => {
                        showNotification('Error generating quotation: ' + error.message, 'error');
                    });
            });
        }

        // Generate invoice
        function generateInvoice(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('invoiceCustomer').value;
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const notes = document.getElementById('invoiceNotes').value;
            
            if (!customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }
            
            const invoiceItems = [];
            let total = 0;
            
            document.querySelectorAll('#invoiceItemsTable tbody tr').forEach(row => {
                const cells = row.cells;
                const item = {
                    product: cells[0].textContent,
                    quantity: parseInt(cells[1].textContent),
                    price: parseFloat(cells[2].textContent.replace('MVR', '')),
                    total: parseFloat(cells[3].textContent.replace('MVR', ''))
                };
                invoiceItems.push(item);
                total += item.total;
            });
            
            if (invoiceItems.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }
            
            database.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                
                const invoice = {
                    number: invoiceNumber,
                    date,
                    dueDate,
                    customer: {
                        id: customerId,
                        name: customer.name,
                        contact: customer.contact,
                        address: customer.address
                    },
                    items: invoiceItems,
                    total,
                    notes,
                    createdAt: new Date().toISOString()
                };
                
                database.ref('invoices').push(invoice)
                    .then(() => {
                        showNotification('Invoice generated successfully!');
                        previewDocument('invoice', invoice);
                        document.getElementById('invoiceForm').reset();
                        document.getElementById('invoiceItemsTable').querySelector('tbody').innerHTML = '';
                    })
                    .catch(error => {
                        showNotification('Error generating invoice: ' + error.message, 'error');
                    });
            });
        }

        // Preview document
        function previewDocument(type, document) {
            const documentPreviewTitle = document.getElementById('documentPreviewTitle');
            const documentPreviewBody = document.getElementById('documentPreviewBody');
            
            documentPreviewTitle.textContent = type === 'quotation' ? 'Quotation Preview' : 'Invoice Preview';
            
            // Get store settings from the form fields
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            
            let documentHTML = `
                <div class="document-container">
                    <div class="document-header">
                        <h2>${storeName}</h2>
                        <p>${storeAddress}</p>
                        <p>Tel: ${storePhone} | Email: ${storeEmail}</p>
                        <h3>${type === 'quotation' ? 'QUOTATION' : 'INVOICE'}</h3>
                        <button class="fullscreen-btn" id="fullscreenDocBtn">
                            <i class="fas fa-expand"></i> Full Screen
                        </button>
                    </div>
                    <div class="document-details">
                        <div class="document-to">
                            <h4>To:</h4>
                            <p>${document.customer.name}</p>
                            <p>${document.customer.contact}</p>
                            <p>${document.customer.address || ''}</p>
                        </div>
                        <div class="document-from">
                            <p><strong>${type === 'quotation' ? 'Quotation' : 'Invoice'} #:</strong> ${document.number}</p>
                            <p><strong>Date:</strong> ${document.date}</p>
                            ${type === 'quotation' ? `<p><strong>Valid Until:</strong> ${document.validUntil}</p>` : `<p><strong>Due Date:</strong> ${document.dueDate}</p>`}
                        </div>
                    </div>
                    <table class="document-items">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            document.items.forEach(item => {
                documentHTML += `
                    <tr>
                        <td>${item.product}</td>
                        <td>${item.quantity}</td>
                        <td>MVR ${item.price.toFixed(2)}</td>
                        <td>MVR ${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            documentHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                                <td><strong>MVR ${document.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    ${document.notes ? `<div class="document-notes"><p><strong>Notes:</strong> ${document.notes}</p></div>` : ''}
                    <div class="document-footer">
                        <p>Thank you for your business!</p>
                    </div>
                </div>
            `;
            
            documentPreviewBody.innerHTML = documentHTML;
            documentPreviewModal.style.display = 'block';
            currentDocument = { type, ...document };
            
            // Add fullscreen button event listener
            document.getElementById('fullscreenDocBtn').addEventListener('click', () => {
                showFullscreenDocument(type, document);
            });
        }

        // Show fullscreen document
        function showFullscreenDocument(type, document) {
            documentPreviewModal.style.display = 'none';
            
            const fullscreenDoc = document.createElement('div');
            fullscreenDoc.className = 'invoice-fullscreen';
            fullscreenDoc.innerHTML = `
                <div class="fullscreen-controls">
                    <button class="btn btn-secondary" id="exitFullscreenBtn">
                        <i class="fas fa-times"></i> Exit Full Screen
                    </button>
                    <button class="btn" id="printFullscreenBtn">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                <div class="invoice-container">
                    ${generateDocumentHTML(type, document)}
                </div>
            `;
            
            document.body.appendChild(fullscreenDoc);
            
            // Add event listeners
            document.getElementById('exitFullscreenBtn').addEventListener('click', () => {
                document.body.removeChild(fullscreenDoc);
                documentPreviewModal.style.display = 'block';
            });
            
            document.getElementById('printFullscreenBtn').addEventListener('click', () => {
                window.print();
            });
        }

        // Generate document HTML
        function generateDocumentHTML(type, document) {
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            
            return `
                <div class="invoice-header">
                    <div class="invoice-logo">${storeName}</div>
                    <p>${storeAddress}</p>
                    <p>Tel: ${storePhone} | Email: ${storeEmail}</p>
                    <h2>${type === 'quotation' ? 'QUOTATION' : 'INVOICE'}</h2>
                </div>
                
                <div class="invoice-details">
                    <div class="invoice-to">
                        <h3>Bill To:</h3>
                        <p>${document.customer.name}</p>
                        <p>${document.customer.contact}</p>
                        <p>${document.customer.address || ''}</p>
                    </div>
                    
                    <div class="invoice-from">
                        <p><strong>${type === 'quotation' ? 'Quotation' : 'Invoice'} #:</strong> ${document.number}</p>
                        <p><strong>Date:</strong> ${document.date}</p>
                        ${type === 'quotation' ? `<p><strong>Valid Until:</strong> ${document.validUntil}</p>` : `<p><strong>Due Date:</strong> ${document.dueDate}</p>`}
                    </div>
                </div>
                
                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${document.items.map(item => `
                            <tr>
                                <td>${item.product}</td>
                                <td>${item.quantity}</td>
                                <td>MVR ${item.price.toFixed(2)}</td>
                                <td>MVR ${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="invoice-total-row grand-total">
                            <td colspan="3">Total</td>
                            <td>MVR ${document.total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                ${document.notes ? `<div class="document-notes"><p><strong>Notes:</strong> ${document.notes}</p></div>` : ''}
                
                <div class="invoice-footer">
                    <p>Thank you for your business!</p>
                    <p>${storeName}</p>
                </div>
            `;
        }

        // Print document
        function printDocument() {
            const printContent = document.getElementById('documentPreviewBody').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reinitialize event listeners
            initAdmin();
        }

       function downloadDocumentAsPdf() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Get settings
    const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
    const storeAddress = document.getElementById('storeAddress').value || '';
    const storePhone = document.getElementById('storePhone').value || '';
    const storeEmail = document.getElementById('storeEmail').value || '';
    const storeLogo = document.getElementById('storeLogo').value || '';
    const bankDetails = document.getElementById('bankDetails').value || '';
    
    let yPosition = 15;
    
    // Add logo if available
    if (storeLogo) {
        try {
            // Note: This is a simplified approach. For production, you might need to handle CORS and image loading properly
            doc.addImage(storeLogo, 'PNG', 14, yPosition, 40, 20);
            yPosition += 25;
        } catch (error) {
            console.error('Error loading logo:', error);
            // Fallback to text logo
            doc.setFontSize(16);
            doc.text(storeName, 105, yPosition, { align: 'center' });
            yPosition += 10;
        }
    } else {
        // Text logo
        doc.setFontSize(16);
        doc.text(storeName, 105, yPosition, { align: 'center' });
        yPosition += 10;
    }
    
    // Add company details
    doc.setFontSize(10);
    doc.text(storeAddress, 105, yPosition, { align: 'center' });
    yPosition += 5;
    doc.text(`Tel: ${storePhone} | Email: ${storeEmail}`, 105, yPosition, { align: 'center' });
    yPosition += 10;
    
    // Add document title
    doc.setFontSize(16);
    doc.text(currentDocument.type === 'quotation' ? 'QUOTATION' : 'INVOICE', 105, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Add document details
    doc.setFontSize(10);
    doc.text(`Date: ${currentDocument.date}`, 14, yPosition);
    if (currentDocument.type === 'quotation') {
        doc.text(`Valid Until: ${currentDocument.validUntil}`, 14, yPosition + 5);
        yPosition += 10;
    } else {
        doc.text(`Due Date: ${currentDocument.dueDate}`, 14, yPosition + 5);
        yPosition += 10;
    }
    doc.text(`${currentDocument.type === 'quotation' ? 'Quotation' : 'Invoice'} #: ${currentDocument.number}`, 14, yPosition);
    
    // Add customer details
    yPosition += 15;
    doc.setFontSize(12);
    doc.text(currentDocument.type === 'quotation' ? 'Quotation To:' : 'Bill To:', 14, yPosition);
    doc.setFontSize(10);
    doc.text(currentDocument.customer.name, 14, yPosition + 5);
    doc.text(currentDocument.customer.contact, 14, yPosition + 10);
    doc.text(currentDocument.customer.address || '', 14, yPosition + 15);
    
    // Add items table
    const tableColumn = ["Description", "Qty", "Price", "Total"];
    const tableRows = [];
    
    currentDocument.items.forEach(item => {
        const itemData = [
            item.product,
            item.quantity.toString(),
            `MVR ${item.price.toFixed(2)}`,
            `MVR ${item.total.toFixed(2)}`
        ];
        tableRows.push(itemData);
    });
    
    // Add total row
    tableRows.push([
        "",
        "",
        "Total:",
        `MVR ${currentDocument.total.toFixed(2)}`
    ]);
    
    doc.autoTable({
        startY: yPosition + 20,
        head: [tableColumn],
        body: tableRows,
        theme: 'grid',
        styles: { fontSize: 10 },
        headStyles: { fillColor: [74, 158, 91] }
    });
    
    // Add notes if available
    let finalY = doc.lastAutoTable.finalY + 10;
    if (currentDocument.notes) {
        doc.text(`Notes: ${currentDocument.notes}`, 14, finalY);
        finalY += 10;
    }
    
    // Add bank details if available
    if (bankDetails) {
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('Bank Details:', 14, finalY);
        doc.setFont(undefined, 'normal');
        
        const bankLines = bankDetails.split('\n');
        bankLines.forEach((line, index) => {
            doc.text(line, 14, finalY + 5 + (index * 5));
        });
        
        finalY += 10 + (bankLines.length * 5);
    }
    
    // Add footer
    doc.setFontSize(10);
    doc.text('Thank you for your business!', 105, finalY + 10, { align: 'center' });
    doc.text(storeName, 105, finalY + 15, { align: 'center' });
    
    // Save the PDF
    doc.save(`${currentDocument.type}-${currentDocument.number}.pdf`);
}

        // Export quotation as PDF directly from form
        function exportQuotationAsPdf() {
            // Collect form data and generate PDF without saving to database
            const customerId = document.getElementById('quotationCustomer').value;
            const date = document.getElementById('quotationDate').value;
            const validUntil = document.getElementById('quotationValidUntil').value;
            const quotationNumber = document.getElementById('quotationNumber').value;
            const notes = document.getElementById('quotationNotes').value;
            
            if (!customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }
            
            const quotationItems = [];
            let total = 0;
            
            document.querySelectorAll('#quotationItemsTable tbody tr').forEach(row => {
                const cells = row.cells;
                const item = {
                    product: cells[0].textContent,
                    quantity: parseInt(cells[1].textContent),
                    price: parseFloat(cells[2].textContent.replace('MVR', '')),
                    total: parseFloat(cells[3].textContent.replace('MVR', ''))
                };
                quotationItems.push(item);
                total += item.total;
            });
            
            if (quotationItems.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }
            
            database.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                
                const quotation = {
                    number: quotationNumber,
                    date,
                    validUntil,
                    customer: {
                        id: customerId,
                        name: customer.name,
                        contact: customer.contact,
                        address: customer.address
                    },
                    items: quotationItems,
                    total,
                    notes
                };
                
                currentDocument = { type: 'quotation', ...quotation };
                downloadDocumentAsPdf();
            });
        }

        // Export invoice as PDF directly from form
        function exportInvoiceAsPdf() {
            // Collect form data and generate PDF without saving to database
            const customerId = document.getElementById('invoiceCustomer').value;
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const notes = document.getElementById('invoiceNotes').value;
            
            if (!customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }
            
            const invoiceItems = [];
            let total = 0;
            
            document.querySelectorAll('#invoiceItemsTable tbody tr').forEach(row => {
                const cells = row.cells;
                const item = {
                    product: cells[0].textContent,
                    quantity: parseInt(cells[1].textContent),
                    price: parseFloat(cells[2].textContent.replace('MVR', '')),
                    total: parseFloat(cells[3].textContent.replace('MVR', ''))
                };
                invoiceItems.push(item);
                total += item.total;
            });
            
            if (invoiceItems.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }
            
            database.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                
                const invoice = {
                    number: invoiceNumber,
                    date,
                    dueDate,
                    customer: {
                        id: customerId,
                        name: customer.name,
                        contact: customer.contact,
                        address: customer.address
                    },
                    items: invoiceItems,
                    total,
                    notes
                };
                
                currentDocument = { type: 'invoice', ...invoice };
                downloadDocumentAsPdf();
            });
        }

        // Load documents
        function loadDocuments() {
            if (!userAccess.includes('documents')) return;
            
            const typeFilter = document.getElementById('documentTypeFilter').value;
            const dateFrom = document.getElementById('documentDateFrom').value;
            const dateTo = document.getElementById('documentDateTo').value;
            
            const documentsTable = document.getElementById('documentsTable').querySelector('tbody');
            documentsTable.innerHTML = '';
            
            // Load quotations
            if (!typeFilter || typeFilter === 'quotation') {
                database.ref('quotations').once('value').then(snapshot => {
                    const quotations = snapshot.val();
                    
                    if (quotations) {
                        Object.entries(quotations).forEach(([id, quotation]) => {
                            // Apply date filter
                            if (dateFrom && quotation.date < dateFrom) return;
                            if (dateTo && quotation.date > dateTo) return;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${quotation.number}</td>
                                <td>Quotation</td>
                                <td>${quotation.customer.name}</td>
                                <td>${quotation.date}</td>
                                <td>MVR ${quotation.total.toFixed(2)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-secondary view-document" data-type="quotation" data-id="${id}">View</button>
                                    <button class="btn btn-danger delete-document" data-type="quotation" data-id="${id}">Delete</button>
                                </td>
                            `;
                            documentsTable.appendChild(row);
                        });
                    }
                });
            }
            
            // Load invoices
            if (!typeFilter || typeFilter === 'invoice') {
                database.ref('invoices').once('value').then(snapshot => {
                    const invoices = snapshot.val();
                    
                    if (invoices) {
                        Object.entries(invoices).forEach(([id, invoice]) => {
                            // Apply date filter
                            if (dateFrom && invoice.date < dateFrom) return;
                            if (dateTo && invoice.date > dateTo) return;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${invoice.number}</td>
                                <td>Invoice</td>
                                <td>${invoice.customer.name}</td>
                                <td>${invoice.date}</td>
                                <td>MVR ${invoice.total.toFixed(2)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-secondary view-document" data-type="invoice" data-id="${id}">View</button>
                                    <button class="btn btn-danger delete-document" data-type="invoice" data-id="${id}">Delete</button>
                                </td>
                            `;
                            documentsTable.appendChild(row);
                        });
                    }
                });
            }
            
            // Add event listeners to view buttons
            setTimeout(() => {
                document.querySelectorAll('.view-document').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.type;
                        const id = btn.dataset.id;
                        viewDocument(type, id);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-document').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.type;
                        const id = btn.dataset.id;
                        if (confirm('Are you sure you want to delete this document?')) {
                            deleteDocument(type, id);
                        }
                    });
                });
            }, 500);
        }

        // View document
        function viewDocument(type, id) {
            database.ref(type + 's/' + id).once('value').then(snapshot => {
                const document = snapshot.val();
                if (document) {
                    previewDocument(type, document);
                }
            });
        }

        // Delete document
        function deleteDocument(type, id) {
            database.ref(type + 's/' + id).remove()
                .then(() => {
                    showNotification('Document deleted successfully!');
                    loadDocuments();
                })
                .catch(error => {
                    showNotification('Error deleting document: ' + error.message, 'error');
                });
        }

        // Load products
        function loadProducts() {
            if (!userAccess.includes('products')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const productsTable = document.getElementById('productsTable').querySelector('tbody');
                productsTable.innerHTML = '';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/50?text=No+Image'"></td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>MVR ${product.price?.toFixed(2) || '0.00'}</td>
                            <td>${product.stock !== undefined ? product.stock : 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary edit-product" data-id="${id}">Edit</button>
                                <button class="btn btn-danger delete-product" data-id="${id}">Delete</button>
                            </td>
                        `;
                        productsTable.appendChild(row);
                    });
                }
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        editProduct(productId);
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        deleteProduct(productId);
                    });
                });
            });
        }

        // Edit product (quick edit)
        function editProduct(productId) {
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                if (product) {
                    document.getElementById('quickEditProductId').value = productId;
                    document.getElementById('quickEditProductName').value = product.name;
                    document.getElementById('quickEditProductPrice').value = product.price;
                    document.getElementById('quickEditProductStock').value = product.stock || '';
                    document.getElementById('quickEditProductImage').value = product.image;
                    
                    // Load categories for the select
                    const categorySelect = document.getElementById('quickEditProductCategory');
                    categorySelect.innerHTML = '<option value="">Select Category</option>';
                    
                    database.ref('categories').once('value').then(catSnapshot => {
                        const categories = catSnapshot.val();
                        if (categories) {
                            Object.values(categories).forEach(category => {
                                const option = document.createElement('option');
                                option.value = category;
                                option.textContent = category;
                                if (category === product.category) {
                                    option.selected = true;
                                }
                                categorySelect.appendChild(option);
                            });
                        }
                    });
                    
                    quickEditProductModal.style.display = 'block';
                }
            });
        }

        // Save quick edit product
        function saveQuickEditProduct(e) {
            e.preventDefault();
            
            const productId = document.getElementById('quickEditProductId').value;
            const product = {
                name: document.getElementById('quickEditProductName').value,
                category: document.getElementById('quickEditProductCategory').value,
                price: parseFloat(document.getElementById('quickEditProductPrice').value),
                image: document.getElementById('quickEditProductImage').value,
                updatedAt: new Date().toISOString()
            };
            
            // Only update stock if provided
            const stockValue = document.getElementById('quickEditProductStock').value;
            if (stockValue) {
                product.stock = parseInt(stockValue);
            }
            
            database.ref('products/' + productId).update(product)
                .then(() => {
                    showNotification('Product updated successfully!');
                    quickEditProductModal.style.display = 'none';
                    loadProducts();
                })
                .catch(error => {
                    showNotification('Error updating product: ' + error.message, 'error');
                });
        }

        // Load categories
        function loadCategories() {
            if (!userAccess.includes('categories')) return;
            
            database.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val();
                const categoriesTable = document.getElementById('categoriesTable').querySelector('tbody');
                const categorySelect = document.getElementById('productCategory');
                const quickEditCategorySelect = document.getElementById('quickEditProductCategory');
                
                categoriesTable.innerHTML = '';
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                quickEditCategorySelect.innerHTML = '<option value="">Select Category</option>';
                
                if (categories) {
                    Object.entries(categories).forEach(([id, category]) => {
                        // Add to table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger delete-category" data-id="${id}">Delete</button>
                            </td>
                        `;
                        categoriesTable.appendChild(row);
                        
                        // Add to select elements
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                        
                        const option2 = document.createElement('option');
                        option2.value = category;
                        option2.textContent = category;
                        quickEditCategorySelect.appendChild(option2);
                    });
                }
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-category').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const categoryId = btn.dataset.id;
                        deleteCategory(categoryId);
                    });
                });
            });
        }

        // Load orders with filters
        function loadOrders() {
            if (!userAccess.includes('orders')) return;
            
            const statusFilter = document.getElementById('orderStatusFilter').value;
            const dateFrom = document.getElementById('orderDateFrom').value;
            const dateTo = document.getElementById('orderDateTo').value;
            
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
                const ordersTableFooter = document.getElementById('ordersTableFooter');
                ordersTable.innerHTML = '';
                ordersTableFooter.innerHTML = '';
                
                let totalAmount = 0;
                let orderCount = 0;
                
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        // Apply filters
                        if (statusFilter && order.status !== statusFilter) return;
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        const amount = order.total || 0;
                        totalAmount += amount;
                        orderCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.orderNumber || id}</td>
                            <td>${order.customer?.name || 'N/A'}</td>
                            <td>${order.date || 'N/A'}</td>
                            <td>MVR ${amount.toFixed(2)}</td>
                            <td>${order.paymentMethod || 'N/A'}</td>
                            <td>
                                <select class="order-status-select" data-id="${id}">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="on-the-way" ${order.status === 'on-the-way' ? 'selected' : ''}>On the Way</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-order" data-id="${id}">View</button>
                                <button class="btn btn-danger delete-order" data-id="${id}">Delete</button>
                            </td>
                        `;
                        ordersTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (orderCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td colspan="3">Subtotal (${orderCount} orders)</td>
                            <td>MVR ${totalAmount.toFixed(2)}</td>
                            <td colspan="3"></td>
                        `;
                        ordersTableFooter.appendChild(footerRow);
                    }
                }
                
                // Add event listeners to status selects
                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.addEventListener('change', () => {
                        const orderId = select.dataset.id;
                        const newStatus = select.value;
                        updateOrderStatus(orderId, newStatus);
                    });
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        viewOrder(orderId);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        if (confirm('Are you sure you want to delete this order?')) {
                            deleteOrder(orderId);
                        }
                    });
                });
            });
        }

        // Load stock
        function loadStock() {
            if (!userAccess.includes('stock')) return;
            
            const statusFilter = document.getElementById('stockStatusFilter').value;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const stockTable = document.getElementById('stockTable').querySelector('tbody');
                const adjustmentProductSelect = document.getElementById('adjustmentProduct');
                const stockHistoryProductSelect = document.getElementById('stockHistoryProduct');
                
                stockTable.innerHTML = '';
                adjustmentProductSelect.innerHTML = '<option value="">Select Product</option>';
                stockHistoryProductSelect.innerHTML = '<option value="">All Products</option>';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        // Apply stock status filter
                        let showProduct = true;
                        if (statusFilter === 'low' && (!product.stock || product.stock > product.minStock)) {
                            showProduct = false;
                        } else if (statusFilter === 'out' && product.stock > 0) {
                            showProduct = false;
                        } else if (statusFilter === 'sufficient' && (!product.stock || product.stock <= product.minStock)) {
                            showProduct = false;
                        }
                        
                        if (!showProduct) return;
                        
                        // Determine stock status
                        let status = 'Sufficient';
                        let statusClass = '';
                        if (product.stock === 0) {
                            status = 'Out of Stock';
                            statusClass = 'stock-alert';
                        } else if (product.stock <= product.minStock) {
                            status = 'Low Stock';
                            statusClass = 'stock-alert';
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.category || 'N/A'}</td>
                            <td class="${statusClass}">${product.stock !== undefined ? product.stock : 'N/A'}</td>
                            <td>${product.minStock !== undefined ? product.minStock : 'N/A'}</td>
                            <td>${status}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary adjust-stock" data-id="${id}">Adjust</button>
                            </td>
                        `;
                        stockTable.appendChild(row);
                        
                        // Add to select elements
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = product.name;
                        adjustmentProductSelect.appendChild(option);
                        
                        const option2 = document.createElement('option');
                        option2.value = id;
                        option2.textContent = product.name;
                        stockHistoryProductSelect.appendChild(option2);
                    });
                }
                
                // Add event listeners to adjust buttons
                document.querySelectorAll('.adjust-stock').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        switchSubTab('stock-adjustment');
                        document.getElementById('adjustmentProduct').value = productId;
                    });
                });
            });
        }

        // Load stock history
        function loadStockHistory() {
            if (!userAccess.includes('stock')) return;
            
            const productFilter = document.getElementById('stockHistoryProduct').value;
            const dateFrom = document.getElementById('stockHistoryDateFrom').value;
            const dateTo = document.getElementById('stockHistoryDateTo').value;
            
            database.ref('stockHistory').orderByChild('createdAt').once('value').then(snapshot => {
                const history = snapshot.val();
                const stockHistoryTable = document.getElementById('stockHistoryTable').querySelector('tbody');
                stockHistoryTable.innerHTML = '';
                
                if (history) {
                    Object.entries(history).forEach(([id, record]) => {
                        // Apply filters
                        if (productFilter && record.productId !== productFilter) return;
                        if (dateFrom && record.createdAt < dateFrom) return;
                        if (dateTo && record.createdAt > dateTo) return;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(record.createdAt).toLocaleDateString()}</td>
                            <td>${record.productName}</td>
                            <td>${record.type}</td>
                            <td>${record.quantity > 0 ? '+' : ''}${record.quantity}</td>
                            <td>${record.previousStock}</td>
                            <td>${record.newStock}</td>
                            <td>${record.notes || 'N/A'}</td>
                        `;
                        stockHistoryTable.appendChild(row);
                    });
                }
            });
        }

        // Load customers
        function loadCustomers() {
            if (!userAccess.includes('customers')) return;
            
            const searchFilter = document.getElementById('customerSearch').value.toLowerCase();
            
            database.ref('customers').once('value').then(snapshot => {
                const customers = snapshot.val();
                const customersTable = document.getElementById('customersTable').querySelector('tbody');
                const creditCustomerFilter = document.getElementById('creditCustomerFilter');
                const creditOrderCustomerFilter = document.getElementById('creditOrderCustomerFilter');
                
                customersTable.innerHTML = '';
                creditCustomerFilter.innerHTML = '<option value="">All Customers</option>';
                creditOrderCustomerFilter.innerHTML = '<option value="">All Customers</option>';
                
                if (customers) {
                    Object.entries(customers).forEach(([id, customer]) => {
                        // Apply search filter
                        if (searchFilter && 
                            !customer.name.toLowerCase().includes(searchFilter) && 
                            !customer.contact.toLowerCase().includes(searchFilter)) {
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.name}</td>
                            <td>${customer.contact}</td>
                            <td>${customer.job || 'N/A'}</td>
                            <td>${customer.address || 'N/A'}</td>
                            <td>MVR ${customer.creditLimit?.toFixed(2) || '0.00'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary edit-customer" data-id="${id}">Edit</button>
                                <button class="btn btn-danger delete-customer" data-id="${id}">Delete</button>
                            </td>
                        `;
                        customersTable.appendChild(row);
                        
                        // Add to credit customer filters
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = customer.name;
                        creditCustomerFilter.appendChild(option);
                        
                        const option2 = document.createElement('option');
                        option2.value = id;
                        option2.textContent = customer.name;
                        creditOrderCustomerFilter.appendChild(option2);
                    });
                }
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-customer').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        editCustomer(customerId);
                    });
                });
                
                document.querySelectorAll('.delete-customer').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        deleteCustomer(customerId);
                    });
                });
            });
        }

        // Edit customer
        function editCustomer(customerId) {
            database.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                if (customer) {
                    document.getElementById('editCustomerId').value = customerId;
                    document.getElementById('editCustomerName').value = customer.name;
                    document.getElementById('editCustomerContact').value = customer.contact;
                    document.getElementById('editCustomerJob').value = customer.job || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    document.getElementById('editCustomerCreditLimit').value = customer.creditLimit || 0;
                    
                    editCustomerModal.style.display = 'block';
                }
            });
        }

        // Save customer edit
        function saveCustomerEdit(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('editCustomerId').value;
            const customer = {
                name: document.getElementById('editCustomerName').value,
                contact: document.getElementById('editCustomerContact').value,
                job: document.getElementById('editCustomerJob').value,
                address: document.getElementById('editCustomerAddress').value,
                creditLimit: parseFloat(document.getElementById('editCustomerCreditLimit').value) || 0,
                updatedAt: new Date().toISOString()
            };
            
            database.ref('customers/' + customerId).update(customer)
                .then(() => {
                    // Update credit account if credit limit changed
                    if (customer.creditLimit > 0) {
                        database.ref('creditAccounts/' + customerId).once('value').then(snapshot => {
                            const creditAccount = snapshot.val() || {};
                            database.ref('creditAccounts/' + customerId).set({
                                customerId: customerId,
                                customerName: customer.name,
                                creditLimit: customer.creditLimit,
                                balance: creditAccount.balance || 0,
                                lastUpdated: new Date().toISOString()
                            });
                        });
                    }
                    
                    showNotification('Customer updated successfully!');
                    editCustomerModal.style.display = 'none';
                    loadCustomers();
                    loadCreditAccounts();
                })
                .catch(error => {
                    showNotification('Error updating customer: ' + error.message, 'error');
                });
        }

        // MODIFIED: Load credit accounts - Improved with contact information
        function loadCreditAccounts() {
            if (!userAccess.includes('credit')) return;
            
            const statusFilter = document.getElementById('creditStatusFilter').value;
            
            database.ref('creditAccounts').once('value').then(snapshot => {
                const accounts = snapshot.val();
                const creditTable = document.getElementById('creditTable').querySelector('tbody');
                creditTable.innerHTML = '';
                
                if (accounts) {
                    Object.entries(accounts).forEach(([id, account]) => {
                        // Apply status filter
                        let showAccount = true;
                        if (statusFilter === 'active' && account.balance === 0) {
                            showAccount = false;
                        } else if (statusFilter === 'overdue' && account.balance <= 0) {
                            showAccount = false;
                        } else if (statusFilter === 'settled' && account.balance > 0) {
                            showAccount = false;
                        }
                        
                        if (!showAccount) return;
                        
                        // Determine credit status
                        let status = 'Settled';
                        let statusClass = 'credit-status paid';
                        if (account.balance > 0) {
                            status = 'Active';
                            statusClass = 'credit-status pending';
                            
                            // Check if overdue (assuming 30 days credit terms)
                            const lastUpdated = new Date(account.lastUpdated);
                            const today = new Date();
                            const daysDiff = Math.floor((today - lastUpdated) / (1000 * 60 * 60 * 24));
                            
                            if (daysDiff > 30) {
                                status = 'Overdue';
                                statusClass = 'credit-status overdue';
                            }
                        }
                        
                        // Get customer contact information
                        database.ref('customers/' + id).once('value').then(customerSnapshot => {
                            const customer = customerSnapshot.val();
                            const contact = customer ? customer.contact : 'N/A';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${account.customerName}</td>
                                <td>${contact}</td>
                                <td>MVR ${account.creditLimit?.toFixed(2) || '0.00'}</td>
                                <td>MVR ${account.balance?.toFixed(2) || '0.00'}</td>
                                <td><span class="${statusClass}">${status}</span></td>
                                <td>${new Date(account.lastUpdated).toLocaleDateString()}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-info view-credit" data-id="${id}">View</button>
                                    <button class="btn btn-secondary settle-credit" data-id="${id}">Settle</button>
                                    <button class="btn btn-secondary view-credit-orders" data-id="${id}">View Orders</button>
                                    <button class="btn btn-danger delete-credit-account" data-id="${id}">Delete</button>
                                </td>
                            `;
                            creditTable.appendChild(row);
                            
                            // Add event listeners to action buttons
                            row.querySelector('.view-credit').addEventListener('click', () => {
                                const customerId = id;
                                switchSubTab('credit-transactions');
                                document.getElementById('creditCustomerFilter').value = customerId;
                                loadCreditTransactions();
                            });
                            
                            row.querySelector('.settle-credit').addEventListener('click', () => {
                                const customerId = id;
                                showSettlementModal(customerId);
                            });
                            
                            row.querySelector('.view-credit-orders').addEventListener('click', () => {
                                const customerId = id;
                                switchSubTab('credit-orders');
                                document.getElementById('creditOrderCustomerFilter').value = customerId;
                                loadCreditOrders();
                            });
                            
                            row.querySelector('.delete-credit-account').addEventListener('click', () => {
                                const customerId = id;
                                if (confirm('Are you sure you want to delete this credit account? This will also delete all associated transactions.')) {
                                    deleteCreditAccount(customerId);
                                }
                            });
                        });
                    });
                }
            });
        }

        // NEW: Delete credit account
        function deleteCreditAccount(customerId) {
            // Delete credit account
            database.ref('creditAccounts/' + customerId).remove()
                .then(() => {
                    // Delete all credit transactions for this customer
                    return database.ref('creditTransactions').orderByChild('customerId').equalTo(customerId).once('value').then(snapshot => {
                        const transactions = snapshot.val();
                        if (transactions) {
                            const deletePromises = Object.keys(transactions).map(transactionId => {
                                return database.ref('creditTransactions/' + transactionId).remove();
                            });
                            return Promise.all(deletePromises);
                        }
                    });
                })
                .then(() => {
                    showNotification('Credit account and all associated transactions deleted successfully!');
                    loadCreditAccounts();
                    loadCreditTransactions();
                })
                .catch(error => {
                    showNotification('Error deleting credit account: ' + error.message, 'error');
                });
        }

        // MODIFIED: Load credit transactions - Improved with contact information
        function loadCreditTransactions() {
            if (!userAccess.includes('credit')) return;
            
            const customerFilter = document.getElementById('creditCustomerFilter').value;
            const dateFrom = document.getElementById('creditDateFrom').value;
            const dateTo = document.getElementById('creditDateTo').value;
            
            database.ref('creditTransactions').orderByChild('createdAt').once('value').then(snapshot => {
                const transactions = snapshot.val();
                const creditTransactionsTable = document.getElementById('creditTransactionsTable').querySelector('tbody');
                creditTransactionsTable.innerHTML = '';
                
                if (transactions) {
                    Object.entries(transactions).forEach(([id, transaction]) => {
                        // Apply filters
                        if (customerFilter && transaction.customerId !== customerFilter) return;
                        if (dateFrom && transaction.createdAt < dateFrom) return;
                        if (dateTo && transaction.createdAt > dateTo) return;
                        
                        // Get customer contact information
                        database.ref('customers/' + transaction.customerId).once('value').then(customerSnapshot => {
                            const customer = customerSnapshot.val();
                            const contact = customer ? customer.contact : 'N/A';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(transaction.createdAt).toLocaleDateString()}</td>
                                <td>${transaction.customerName}</td>
                                <td>${contact}</td>
                                <td>${transaction.type}</td>
                                <td>MVR ${transaction.amount?.toFixed(2) || '0.00'}</td>
                                <td>MVR ${transaction.balance?.toFixed(2) || '0.00'}</td>
                                <td>${transaction.orderNumber || 'N/A'}</td>
                                <td class="action-buttons">
                                    ${transaction.type === 'purchase' ? `<button class="btn btn-secondary view-order" data-id="${transaction.orderId}">View Order</button>` : ''}
                                    <button class="btn btn-danger delete-credit-transaction" data-id="${id}">Delete</button>
                                </td>
                            `;
                            creditTransactionsTable.appendChild(row);
                            
                            // Add event listeners to view order buttons
                            if (transaction.type === 'purchase') {
                                row.querySelector('.view-order').addEventListener('click', () => {
                                    const orderId = transaction.orderId;
                                    viewOrder(orderId);
                                });
                            }
                            
                            // Add event listener to delete transaction button
                            row.querySelector('.delete-credit-transaction').addEventListener('click', () => {
                                const transactionId = id;
                                if (confirm('Are you sure you want to delete this credit transaction?')) {
                                    deleteCreditTransaction(transactionId, transaction.customerId, transaction.amount);
                                }
                            });
                        });
                    });
                }
            });
        }

        // NEW: Delete credit transaction
        function deleteCreditTransaction(transactionId, customerId, amount) {
            // Delete the transaction
            database.ref('creditTransactions/' + transactionId).remove()
                .then(() => {
                    // Update the credit account balance
                    return database.ref('creditAccounts/' + customerId).once('value').then(snapshot => {
                        const account = snapshot.val();
                        if (account) {
                            const newBalance = account.balance - amount;
                            return database.ref('creditAccounts/' + customerId).update({
                                balance: newBalance,
                                lastUpdated: new Date().toISOString()
                            });
                        }
                    });
                })
                .then(() => {
                    showNotification('Credit transaction deleted successfully!');
                    loadCreditTransactions();
                    loadCreditAccounts();
                })
                .catch(error => {
                    showNotification('Error deleting credit transaction: ' + error.message, 'error');
                });
        }

        // FIXED: Load credit orders - Now properly shows credit orders with customer information
        function loadCreditOrders() {
            if (!userAccess.includes('credit')) return;
            
            const customerFilter = document.getElementById('creditOrderCustomerFilter').value;
            const dateFrom = document.getElementById('creditOrderDateFrom').value;
            const dateTo = document.getElementById('creditOrderDateTo').value;
            
            database.ref('orders').orderByChild('createdAt').once('value').then(snapshot => {
                const orders = snapshot.val();
                const creditOrdersTable = document.getElementById('creditOrdersTable').querySelector('tbody');
                creditOrdersTable.innerHTML = '';
                
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        // Apply filters - only show credit orders
                        if (order.paymentMethod !== 'credit') return;
                        
                        // Apply customer filter
                        if (customerFilter && order.customer?.id !== customerFilter) return;
                        
                        // Apply date filter
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        // Get customer contact information
                        const customerId = order.customer?.id;
                        if (customerId) {
                            database.ref('customers/' + customerId).once('value').then(customerSnapshot => {
                                const customer = customerSnapshot.val();
                                const contact = customer ? customer.contact : 'N/A';
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${order.orderNumber || id}</td>
                                    <td>${order.customer?.name || 'N/A'}</td>
                                    <td>${contact}</td>
                                    <td>${order.date || 'N/A'}</td>
                                    <td>MVR ${order.total?.toFixed(2) || '0.00'}</td>
                                    <td>${order.status || 'pending'}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-secondary view-order" data-id="${id}">View</button>
                                        <button class="btn btn-info view-invoice" data-id="${id}">Invoice</button>
                                    </td>
                                `;
                                creditOrdersTable.appendChild(row);
                                
                                // Add event listeners to view buttons
                                row.querySelector('.view-order').addEventListener('click', () => {
                                    const orderId = id;
                                    viewOrder(orderId);
                                });
                                
                                // Add event listeners to invoice buttons
                                row.querySelector('.view-invoice').addEventListener('click', () => {
                                    const orderId = id;
                                    viewOrderInvoice(orderId);
                                });
                            });
                        } else {
                            // For orders without customer ID (legacy data), still show them
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order.orderNumber || id}</td>
                                <td>${order.customer?.name || 'N/A'}</td>
                                <td>N/A</td>
                                <td>${order.date || 'N/A'}</td>
                                <td>MVR ${order.total?.toFixed(2) || '0.00'}</td>
                                <td>${order.status || 'pending'}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-secondary view-order" data-id="${id}">View</button>
                                    <button class="btn btn-info view-invoice" data-id="${id}">Invoice</button>
                                </td>
                            `;
                            creditOrdersTable.appendChild(row);
                            
                            // Add event listeners to view buttons
                            row.querySelector('.view-order').addEventListener('click', () => {
                                const orderId = id;
                                viewOrder(orderId);
                            });
                            
                            // Add event listeners to invoice buttons
                            row.querySelector('.view-invoice').addEventListener('click', () => {
                                const orderId = id;
                                viewOrderInvoice(orderId);
                            });
                        }
                    });
                }
            });
        }

        // Show settlement modal
        function showSettlementModal(customerId) {
            currentCreditAccountId = customerId;
            
            database.ref('creditAccounts/' + customerId).once('value').then(snapshot => {
                const account = snapshot.val();
                
                document.getElementById('settlementAmount').value = account.balance.toFixed(2);
                document.getElementById('settlementAmount').max = account.balance;
                
                creditSettlementModal.style.display = 'block';
            });
        }

        // Settle credit
        function settleCredit() {
            const amount = parseFloat(document.getElementById('settlementAmount').value);
            const method = document.getElementById('settlementMethod').value;
            const notes = document.getElementById('settlementNotes').value;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            database.ref('creditAccounts/' + currentCreditAccountId).once('value').then(snapshot => {
                const account = snapshot.val();
                const newBalance = account.balance - amount;
                
                if (newBalance < 0) {
                    showNotification('Settlement amount cannot exceed current balance', 'error');
                    return;
                }
                
                // Update credit account
                database.ref('creditAccounts/' + currentCreditAccountId).update({
                    balance: newBalance,
                    lastUpdated: new Date().toISOString()
                }).then(() => {
                    // Record credit transaction
                    return database.ref('creditTransactions').push({
                        customerId: currentCreditAccountId,
                        customerName: account.customerName,
                        type: 'payment',
                        amount: -amount,
                        balance: newBalance,
                        paymentMethod: method,
                        notes: notes,
                        createdAt: new Date().toISOString()
                    });
                }).then(() => {
                    showNotification('Credit account settled successfully');
                    creditSettlementModal.style.display = 'none';
                    loadCreditAccounts();
                    loadCreditTransactions();
                }).catch(error => {
                    showNotification('Error settling credit: ' + error.message, 'error');
                });
            });
        }

        // View order details
        function viewOrder(orderId) {
            database.ref('orders/' + orderId).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) return;
                
                currentOrderId = orderId;
                
                const modalBody = document.getElementById('orderModalBody');
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Order Number</label>
                        <p>${order.orderNumber || orderId}</p>
                    </div>
                    <div class="form-group">
                        <label>Order Date</label>
                        <p>${order.date || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Name</label>
                        <p>${order.customer?.name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Contact</label>
                        <p>${order.customer?.contact || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <p>${order.paymentMethod || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <p>${order.status || 'pending'}</p>
                    </div>
                    <div class="form-group">
                        <label>Total Amount</label>
                        <p>MVR ${order.total?.toFixed(2) || '0.00'}</p>
                    </div>
                    <div class="form-group">
                        <label>Items</label>
                        <ul>
                            ${order.items ? order.items.map(item => `
                                <li>${item.name} x ${item.quantity} - MVR ${(item.price * item.quantity).toFixed(2)}</li>
                            `).join('') : '<li>No items</li>'}
                        </ul>
                    </div>
                    <div class="invoice-actions">
                        <button class="btn btn-secondary" id="viewOrderInvoiceBtn">View Invoice</button>
                    </div>
                `;
                
                // Add event listener to view invoice button
                document.getElementById('viewOrderInvoiceBtn').addEventListener('click', () => {
                    viewOrderInvoice(orderId);
                });
                
                orderModal.style.display = 'block';
            });
        }

        // View order invoice
        function viewOrderInvoice(orderId) {
            database.ref('orders/' + orderId).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) return;
                
                // Generate invoice HTML
                const invoiceHTML = generateInvoiceHTML(order);
                
                // Create fullscreen invoice
                const fullscreenInvoice = document.createElement('div');
                fullscreenInvoice.className = 'invoice-fullscreen';
                fullscreenInvoice.innerHTML = `
                    <div class="fullscreen-controls">
                        <button class="btn btn-secondary" id="closeFullscreenInvoice">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn" id="printInvoiceBtn">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    <div class="invoice-container">
                        ${invoiceHTML}
                    </div>
                `;
                
                document.body.appendChild(fullscreenInvoice);
                
                // Add event listeners
                document.getElementById('closeFullscreenInvoice').addEventListener('click', () => {
                    document.body.removeChild(fullscreenInvoice);
                });
                
                document.getElementById('printInvoiceBtn').addEventListener('click', () => {
                    window.print();
                });
            });
        }

        // Generate invoice HTML
        function generateInvoiceHTML(order) {
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            
            return `
                <div class="invoice-header">
                    <div class="invoice-logo">${storeName}</div>
                    <p>${storeAddress}</p>
                    <p>Tel: ${storePhone} | Email: ${storeEmail}</p>
                    <h2>INVOICE</h2>
                </div>
                
                <div class="invoice-details">
                    <div class="invoice-to">
                        <h3>Bill To:</h3>
                        <p>${order.customer?.name || 'Cash Customer'}</p>
                        <p>${order.customer?.contact || ''}</p>
                        <p>${order.customer?.address || ''}</p>
                    </div>
                    
                    <div class="invoice-from">
                        <p><strong>Invoice #:</strong> ${order.orderNumber}</p>
                        <p><strong>Date:</strong> ${order.date || new Date().toISOString().split('T')[0]}</p>
                        <p><strong>Order Type:</strong> ${order.orderType === 'dining' ? 'Dining' : 'Takeaway'}</p>
                        ${order.table ? `<p><strong>Table:</strong> ${order.table}</p>` : ''}
                    </div>
                </div>
                
                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>MVR ${item.price.toFixed(2)}</td>
                                <td>MVR ${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="invoice-total-row grand-total">
                            <td colspan="3">Total</td>
                            <td>MVR ${order.total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="payment-details">
                    <p><strong>Payment Method:</strong> ${order.paymentMethod === 'cash' ? 'Cash' : order.paymentMethod === 'credit' ? 'Credit' : 'Bank Transfer'}</p>
                    <p><strong>Status:</strong> ${order.status || 'completed'}</p>
                </div>
                
                <div class="invoice-footer">
                    <p>Thank you for your business!</p>
                    <p>${storeName}</p>
                </div>
            `;
        }

        // Delete order
        function deleteOrder(orderId = null) {
            const idToDelete = orderId || currentOrderId;
            if (!idToDelete) return;
            
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                database.ref('orders/' + idToDelete).remove()
                    .then(() => {
                        showNotification('Order deleted successfully!');
                        orderModal.style.display = 'none';
                        loadDashboardData();
                        loadOrders();
                    })
                    .catch(error => {
                        showNotification('Error deleting order: ' + error.message, 'error');
                    });
            }
        }

        // Delete product
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                database.ref('products/' + productId).remove()
                    .then(() => {
                        showNotification('Product deleted successfully!');
                        loadProducts();
                    })
                    .catch(error => {
                        showNotification('Error deleting product: ' + error.message, 'error');
                    });
            }
        }

        // Delete category
        function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                database.ref('categories/' + categoryId).remove()
                    .then(() => {
                        showNotification('Category deleted successfully!');
                        loadCategories();
                    })
                    .catch(error => {
                        showNotification('Error deleting category: ' + error.message, 'error');
                    });
            }
        }

        // Delete customer
        function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                database.ref('customers/' + customerId).remove()
                    .then(() => {
                        // Also delete credit account if exists
                        database.ref('creditAccounts/' + customerId).remove();
                        showNotification('Customer deleted successfully!');
                        loadCustomers();
                    })
                    .catch(error => {
                        showNotification('Error deleting customer: ' + error.message, 'error');
                    });
            }
        }

        // Update order status
        function updateOrderStatus(orderId, newStatus) {
            database.ref('orders/' + orderId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Order status updated successfully!');
            })
            .catch(error => {
                showNotification('Error updating order status: ' + error.message, 'error');
            });
        }

        // Add product
        function addProduct(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                image: document.getElementById('productImage').value,
                createdAt: new Date().toISOString()
            };
            
            // Only add stock if provided (optional field)
            const stockValue = document.getElementById('productStock').value;
            if (stockValue) {
                product.stock = parseInt(stockValue);
            }
            
            database.ref('products').push(product)
                .then(() => {
                    showNotification('Product added successfully!');
                    document.getElementById('addProductForm').reset();
                    loadProducts();
                })
                .catch(error => {
                    showNotification('Error adding product: ' + error.message, 'error');
                });
        }

        // Add category
        function addCategory(e) {
            e.preventDefault();
            
            const category = document.getElementById('categoryName').value;
            
            database.ref('categories').push(category)
                .then(() => {
                    showNotification('Category added successfully!');
                    document.getElementById('addCategoryForm').reset();
                    loadCategories();
                })
                .catch(error => {
                    showNotification('Error adding category: ' + error.message, 'error');
                });
        }

        // Add customer
        function addCustomer(e) {
            e.preventDefault();
            
            const customer = {
                name: document.getElementById('customerName').value,
                contact: document.getElementById('customerContact').value,
                job: document.getElementById('customerJob').value,
                address: document.getElementById('customerAddress').value,
                creditLimit: parseFloat(document.getElementById('customerCreditLimit').value) || 0,
                createdAt: new Date().toISOString()
            };
            
            database.ref('customers').push(customer)
                .then((ref) => {
                    const customerId = ref.key;
                    
                    // Create credit account if credit limit > 0
                    if (customer.creditLimit > 0) {
                        database.ref('creditAccounts/' + customerId).set({
                            customerId: customerId,
                            customerName: customer.name,
                            creditLimit: customer.creditLimit,
                            balance: 0,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    
                    showNotification('Customer added successfully!');
                    document.getElementById('addCustomerForm').reset();
                    loadCustomers();
                })
                .catch(error => {
                    showNotification('Error adding customer: ' + error.message, 'error');
                });
        }

        // Adjust stock
        function adjustStock(e) {
            e.preventDefault();
            
            const productId = document.getElementById('adjustmentProduct').value;
            const adjustmentType = document.getElementById('adjustmentType').value;
            const quantity = parseInt(document.getElementById('adjustmentQuantity').value);
            const notes = document.getElementById('adjustmentNotes').value;
            
            if (!productId) {
                showNotification('Please select a product', 'error');
                return;
            }
            
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                let newStock = product.stock || 0;
                
                if (adjustmentType === 'add') {
                    newStock += quantity;
                } else if (adjustmentType === 'remove') {
                    newStock -= quantity;
                    if (newStock < 0) newStock = 0;
                } else if (adjustmentType === 'set') {
                    newStock = quantity;
                }
                
                // Update product stock
                database.ref('products/' + productId).update({
                    stock: newStock
                }).then(() => {
                    // Record stock history
                    return database.ref('stockHistory').push({
                        productId: productId,
                        productName: product.name,
                        type: 'adjustment',
                        quantity: adjustmentType === 'add' ? quantity : adjustmentType === 'remove' ? -quantity : newStock - product.stock,
                        previousStock: product.stock,
                        newStock: newStock,
                        notes: notes || 'Manual adjustment',
                        createdAt: new Date().toISOString()
                    });
                }).then(() => {
                    showNotification('Stock adjusted successfully!');
                    document.getElementById('stockAdjustmentForm').reset();
                    loadStock();
                    loadDashboardData();
                }).catch(error => {
                    showNotification('Error adjusting stock: ' + error.message, 'error');
                });
            });
        }

       function loadStoreSettings() {
    database.ref('settings').once('value').then(snapshot => {
        const settings = snapshot.val();
        
        if (settings) {
            if (settings.storeName) document.getElementById('storeName').value = settings.storeName;
            if (settings.storeAddress) document.getElementById('storeAddress').value = settings.storeAddress;
            if (settings.storePhone) document.getElementById('storePhone').value = settings.storePhone;
            if (settings.storeEmail) document.getElementById('storeEmail').value = settings.storeEmail;
            if (settings.storeLogo) document.getElementById('storeLogo').value = settings.storeLogo;
            if (settings.bankDetails) document.getElementById('bankDetails').value = settings.bankDetails;
            if (settings.tableCount) {
                document.getElementById('tableCount').value = settings.tableCount;
                tablesCount = settings.tableCount;
            }
        }
    });
}

        function saveStoreSettings(e) {
    e.preventDefault();
    
    const settings = {
        storeName: document.getElementById('storeName').value,
        storeAddress: document.getElementById('storeAddress').value,
        storePhone: document.getElementById('storePhone').value,
        storeEmail: document.getElementById('storeEmail').value,
        storeLogo: document.getElementById('storeLogo').value,
        bankDetails: document.getElementById('bankDetails').value,
        tableCount: parseInt(document.getElementById('tableCount').value)
    };
    
    database.ref('settings').set(settings)
        .then(() => {
            showNotification('Settings saved successfully!');
            tablesCount = settings.tableCount;
            loadTables();
        })
        .catch(error => {
            showNotification('Error saving settings: ' + error.message, 'error');
        });
}
        // Export to Excel
        function exportToExcel(type) {
            let data = [];
            let fileName = '';
            let subtotal = 0;
            let count = 0;
            
            switch(type) {
                case 'orders':
                    const ordersData = getOrdersData();
                    data = ordersData.data;
                    subtotal = ordersData.subtotal;
                    count = ordersData.count;
                    fileName = 'orders_report.xlsx';
                    break;
                case 'stock':
                    const stockData = getStockData();
                    data = stockData.data;
                    count = stockData.count;
                    fileName = 'stock_report.xlsx';
                    break;
                case 'customers':
                    const customersData = getCustomersData();
                    data = customersData.data;
                    count = customersData.count;
                    fileName = 'customers_report.xlsx';
                    break;
                case 'credit':
                    const creditData = getCreditData();
                    data = creditData.data;
                    count = creditData.count;
                    fileName = 'credit_report.xlsx';
                    break;
                case 'expenses':
                    const expensesData = getExpensesData();
                    data = expensesData.data;
                    subtotal = expensesData.subtotal;
                    count = expensesData.count;
                    fileName = 'expenses_report.xlsx';
                    break;
                case 'balance':
                    const balanceData = getBalanceData();
                    data = balanceData.data;
                    subtotal = balanceData.subtotal;
                    count = balanceData.count;
                    fileName = 'balance_sheet.xlsx';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Add subtotal row
            if (type === 'orders' || type === 'expenses' || type === 'balance') {
                data.push({});
                data.push({
                    'Order #': `Subtotal (${count} ${type === 'orders' ? 'orders' : type === 'expenses' ? 'expenses' : 'items'})`,
                    'Customer': '',
                    'Date': '',
                    'Amount': `MVR ${subtotal.toFixed(2)}`,
                    'Payment Method': '',
                    'Status': ''
                });
            } else if (type === 'stock') {
                data.push({});
                data.push({
                    'Product': `Subtotal (${count} products)`,
                    'Category': '',
                    'Current Stock': '',
                    'Minimum Stock': '',
                    'Status': ''
                });
            } else if (type === 'customers') {
                data.push({});
                data.push({
                    'Name': `Subtotal (${count} customers)`,
                    'Contact': '',
                    'Job': '',
                    'Address': '',
                    'Credit Limit': ''
                });
            } else if (type === 'credit') {
                data.push({});
                data.push({
                    'Customer': `Subtotal (${count} accounts)`,
                    'Contact': '',
                    'Credit Limit': '',
                    'Balance': '',
                    'Status': '',
                    'Last Transaction': ''
                });
            }
            
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
            XLSX.writeFile(workbook, fileName);
            showNotification('Excel file exported successfully!');
        }

        // Export to PDF
        function exportToPdf(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let data = [];
            let headers = [];
            let title = '';
            let subtotal = 0;
            let count = 0;
            
            switch(type) {
                case 'orders':
                    const ordersData = getOrdersData();
                    data = ordersData.data;
                    headers = ['Order #', 'Customer', 'Date', 'Amount', 'Payment Method', 'Status'];
                    subtotal = ordersData.subtotal;
                    count = ordersData.count;
                    title = 'Orders Report';
                    break;
                case 'stock':
                    const stockData = getStockData();
                    data = stockData.data;
                    headers = ['Product', 'Category', 'Current Stock', 'Minimum Stock', 'Status'];
                    count = stockData.count;
                    title = 'Stock Report';
                    break;
                case 'customers':
                    const customersData = getCustomersData();
                    data = customersData.data;
                    headers = ['Name', 'Contact', 'Job', 'Address', 'Credit Limit'];
                    count = customersData.count;
                    title = 'Customers Report';
                    break;
                case 'credit':
                    const creditData = getCreditData();
                    data = creditData.data;
                    headers = ['Customer', 'Contact', 'Credit Limit', 'Balance', 'Status', 'Last Transaction'];
                    count = creditData.count;
                    title = 'Credit Report';
                    break;
                case 'expenses':
                    const expensesData = getExpensesData();
                    data = expensesData.data;
                    headers = ['Date', 'Supplier', 'Invoice #', 'Amount', 'Notes'];
                    subtotal = expensesData.subtotal;
                    count = expensesData.count;
                    title = 'Expenses Report';
                    break;
                case 'balance':
                    const balanceData = getBalanceData();
                    data = balanceData.data;
                    headers = ['Description', 'Amount'];
                    subtotal = balanceData.subtotal;
                    count = balanceData.count;
                    title = 'Balance Sheet';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Add title
            doc.setFontSize(16);
            doc.text(title, 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
            
            // Prepare table data
            const tableData = data.map(row => {
                return headers.map(header => row[header] || '');
            });
            
            // Add table
            doc.autoTable({
                startY: 25,
                head: [headers],
                body: tableData
            });
            
            // Add subtotal
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            
            if (type === 'orders' || type === 'expenses' || type === 'balance') {
                doc.text(`Subtotal (${count} ${type === 'orders' ? 'orders' : type === 'expenses' ? 'expenses' : 'items'}): MVR ${subtotal.toFixed(2)}`, 14, finalY);
            } else {
                doc.text(`Subtotal (${count} items)`, 14, finalY);
            }
            
            // Save the PDF
            doc.save(`${title.toLowerCase().replace(/\s/g, '_')}.pdf`);
            showNotification('PDF file exported successfully!');
        }

        // Get orders data for export
        function getOrdersData() {
            const ordersTable = document.getElementById('ordersTable');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get table rows
            ordersTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Order #': cells[0].textContent.trim(),
                    'Customer': cells[1].textContent.trim(),
                    'Date': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Payment Method': cells[4].textContent.trim(),
                    'Status': cells[5].textContent.trim()
                };
                
                // Extract numeric value from amount
                const amountValue = parseFloat(cells[3].textContent.replace('MVR', '').trim());
                if (!isNaN(amountValue)) {
                    subtotal += amountValue;
                    count++;
                }
                
                data.push(rowData);
            });
            
            return { data, subtotal, count };
        }

        // Get stock data for export
        function getStockData() {
            const stockTable = document.getElementById('stockTable');
            const data = [];
            let count = 0;
            
            // Get table rows
            stockTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Product': cells[0].textContent.trim(),
                    'Category': cells[1].textContent.trim(),
                    'Current Stock': cells[2].textContent.trim(),
                    'Minimum Stock': cells[3].textContent.trim(),
                    'Status': cells[4].textContent.trim()
                };
                
                count++;
                data.push(rowData);
            });
            
            return { data, count };
        }

        // Get customers data for export
        function getCustomersData() {
            const customersTable = document.getElementById('customersTable');
            const data = [];
            let count = 0;
            
            // Get table rows
            customersTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Name': cells[0].textContent.trim(),
                    'Contact': cells[1].textContent.trim(),
                    'Job': cells[2].textContent.trim(),
                    'Address': cells[3].textContent.trim(),
                    'Credit Limit': cells[4].textContent.trim()
                };
                
                count++;
                data.push(rowData);
            });
            
            return { data, count };
        }

        // Get credit data for export
        function getCreditData() {
            const creditTable = document.getElementById('creditTable');
            const data = [];
            let count = 0;
            
            // Get table rows
            creditTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Customer': cells[0].textContent.trim(),
                    'Contact': cells[1].textContent.trim(),
                    'Credit Limit': cells[2].textContent.trim(),
                    'Balance': cells[3].textContent.trim(),
                    'Status': cells[4].textContent.trim(),
                    'Last Transaction': cells[5].textContent.trim()
                };
                
                count++;
                data.push(rowData);
            });
            
            return { data, count };
        }

        // Get expenses data for export
        function getExpensesData() {
            const expensesTable = document.getElementById('expensesTable');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get table rows
            expensesTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Date': cells[0].textContent.trim(),
                    'Supplier': cells[1].textContent.trim(),
                    'Invoice #': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Notes': cells[4].textContent.trim()
                };
                
                // Extract numeric value from amount
                const amountValue = parseFloat(cells[3].textContent.replace('MVR', '').trim());
                if (!isNaN(amountValue)) {
                    subtotal += amountValue;
                    count++;
                }
                
                data.push(rowData);
            });
            
            return { data, subtotal, count };
        }

        // Get balance data for export
        function getBalanceData() {
            const balanceSheet = document.getElementById('balanceSheet');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get balance rows
            balanceSheet.querySelectorAll('.balance-row').forEach(row => {
                const cells = row.querySelectorAll('span');
                if (cells.length === 2) {
                    const description = cells[0].textContent.trim();
                    const amount = cells[1].textContent.trim();
                    
                    const rowData = {
                        'Description': description,
                        'Amount': amount
                    };
                    
                    // Extract numeric value from amount
                    const amountValue = parseFloat(amount.replace('MVR', '').trim());
                    if (!isNaN(amountValue) && description !== 'Net Profit' && description !== 'Net Loss') {
                        if (description === 'Total Expenses') {
                            subtotal -= amountValue;
                        } else {
                            subtotal += amountValue;
                        }
                    }
                    
                    count++;
                    data.push(rowData);
                }
            });
            
            return { data, subtotal, count };
        }

        // Initialize the admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
    <script>
        // Full screen functionality
        document.getElementById('fullscreen-btn').addEventListener('click', function() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            
            document.body.classList.add('fullscreen-mode');
        });
        
        document.getElementById('exit-fullscreen-btn').addEventListener('click', function() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
            
            document.body.classList.remove('fullscreen-mode');
        });
    </script>
      <script>
        // Global variables
        let selectedProductForQuickQuantity = null;

        // DOM elements for enhanced cart
        const quickQuantityModal = document.getElementById('quickQuantityModal');
        const quickQuantityTitle = document.getElementById('quickQuantityTitle');
        const quickQuantityInput = document.getElementById('quickQuantityInput');
        const quickQuantityDecrease = document.getElementById('quickQuantityDecrease');
        const quickQuantityIncrease = document.getElementById('quickQuantityIncrease');
        const cancelQuickQuantity = document.getElementById('cancelQuickQuantity');
        const confirmQuickQuantity = document.getElementById('confirmQuickQuantity');

        // Initialize enhanced cart functionality
        function initEnhancedCart() {
            // Quick quantity modal event listeners
            quickQuantityDecrease.addEventListener('click', () => {
                const currentValue = parseInt(quickQuantityInput.value) || 1;
                if (currentValue > 1) {
                    quickQuantityInput.value = currentValue - 1;
                }
            });
            
            quickQuantityIncrease.addEventListener('click', () => {
                const currentValue = parseInt(quickQuantityInput.value) || 1;
                quickQuantityInput.value = currentValue + 1;
            });
            
            cancelQuickQuantity.addEventListener('click', () => {
                quickQuantityModal.style.display = 'none';
                selectedProductForQuickQuantity = null;
            });
            
            confirmQuickQuantity.addEventListener('click', () => {
                if (selectedProductForQuickQuantity) {
                    const quantity = parseInt(quickQuantityInput.value) || 1;
                    addToCartWithQuantity(selectedProductForQuickQuantity.id, selectedProductForQuickQuantity.product, quantity);
                    quickQuantityModal.style.display = 'none';
                    selectedProductForQuickQuantity = null;
                }
            });
            
            // Allow direct input in quick quantity modal
            quickQuantityInput.addEventListener('input', () => {
                let value = parseInt(quickQuantityInput.value) || 1;
                if (value < 1) value = 1;
                quickQuantityInput.value = value;
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === quickQuantityModal) {
                    quickQuantityModal.style.display = 'none';
                    selectedProductForQuickQuantity = null;
                }
            });
        }

        // MODIFIED: Load products for POS with enhanced functionality
        function loadProductsForPOS() {
            if (!userAccess.includes('pos')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                posProducts.innerHTML = '';
                
                // Load categories for tabs
                database.ref('categories').once('value').then(catSnapshot => {
                    const categories = catSnapshot.val();
                    categoryTabs.innerHTML = '';
                    
                    // Add "All" tab
                    const allTab = document.createElement('div');
                    allTab.className = 'category-tab active';
                    allTab.textContent = 'All';
                    allTab.dataset.category = 'all';
                    allTab.addEventListener('click', () => {
                        document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                        allTab.classList.add('active');
                        currentCategoryFilter = 'all';
                        filterProductsByCategory();
                    });
                    categoryTabs.appendChild(allTab);
                    
                    // Add category tabs
                    if (categories) {
                        Object.values(categories).forEach(category => {
                            const categoryTab = document.createElement('div');
                            categoryTab.className = 'category-tab';
                            categoryTab.textContent = category;
                            categoryTab.dataset.category = category;
                            categoryTab.addEventListener('click', () => {
                                document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                                categoryTab.classList.add('active');
                                currentCategoryFilter = category;
                                filterProductsByCategory();
                            });
                            categoryTabs.appendChild(categoryTab);
                        });
                    }
                });
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        // Only show products with stock > 0 or no stock tracking
                        if (product.stock === undefined || product.stock > 0) {
                            const productCard = document.createElement('div');
                            productCard.className = 'pos-product-card';
                            productCard.dataset.category = product.category || 'Uncategorized';
                            productCard.innerHTML = `
                                <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                <h3>${product.name}</h3>
                                <p>MVR ${product.price?.toFixed(2) || '0.00'}</p>
                                ${product.stock !== undefined ? `<small>Stock: ${product.stock}</small>` : ''}
                                <button class="product-quick-add" data-product-id="${id}">
                                    <i class=""></i>
                                </button>
                            `;
                            
                            // Click on product card adds with quantity 1
                            productCard.addEventListener('click', (e) => {
                                // Don't trigger if quick add button was clicked
                                if (!e.target.closest('.product-quick-add')) {
                                    if (currentOrderType === 'dining' && !currentTable) {
                                        showNotification('Please select a table first', 'error');
                                        return;
                                    }
                                    
                                    if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                                        showNotification('Please select a credit customer first', 'error');
                                        return;
                                    }
                                    
                                    // Directly add product to cart with quantity 1
                                    addToCartDirect(id, product);
                                }
                            });
                            
                            // Quick add button shows quantity modal
                            const quickAddBtn = productCard.querySelector('.product-quick-add');
                            quickAddBtn.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent card click event
                                
                                if (currentOrderType === 'dining' && !currentTable) {
                                    showNotification('Please select a table first', 'error');
                                    return;
                                }
                                
                                if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                                    showNotification('Please select a credit customer first', 'error');
                                    return;
                                }
                                
                                showQuickQuantityModal(id, product);
                            });
                            
                            posProducts.appendChild(productCard);
                        }
                    });
                }
            });
        }

        // NEW: Show quick quantity modal
        function showQuickQuantityModal(productId, product) {
            selectedProductForQuickQuantity = { id: productId, product: product };
            quickQuantityTitle.textContent = `Quantity for ${product.name}`;
            quickQuantityInput.value = '1';
            quickQuantityInput.focus();
            quickQuantityInput.select();
            quickQuantityModal.style.display = 'flex';
        }

        // NEW: Add to cart with specified quantity
        function addToCartWithQuantity(productId, product, quantity) {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (product.stock !== undefined && existingItem.quantity + quantity > product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                // Check if product has stock
                if (product.stock !== undefined && product.stock < quantity) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            updateCart();
            showNotification(`${quantity} x ${product.name} added to cart`);
        }

        // NEW: Directly add product to cart
        function addToCartDirect(productId, product) {
            if (currentOrderType === 'dining' && !currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (!currentCustomerId && creditCustomerBtn.classList.contains('active')) {
                showNotification('Please select a credit customer first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                // Check stock if available
                if (product.stock !== undefined && existingItem.quantity + 1 > product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                // Check if product has stock
                if (product.stock !== undefined && product.stock < 1) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCart();
            showNotification(`${product.name} added to cart`);
        }

        // UPDATED: Enhanced cart display with manual quantity input
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">No items added yet</p>';
                cartTotal.textContent = 'Total: MVR 0.00';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">MVR ${item.price.toFixed(2)} each</div>
                        <div class="cart-item-controls">
                            <button class="quantity-control-btn remove" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="quantity-control-btn" data-action="decrease" data-index="${index}">-</button>
                            <input type="number" class="quantity-input" data-index="${index}" value="${item.quantity}" min="1">
                            <button class="quantity-control-btn" data-action="increase" data-index="${index}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-total">
                        MVR ${itemTotal.toFixed(2)}
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `Total: MVR ${total.toFixed(2)}`;
            
            // Add event listeners to cart controls
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const newQuantity = parseInt(e.target.value) || 1;
                    updateCartItemQuantity(index, newQuantity);
                });
                
                input.addEventListener('blur', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const newQuantity = parseInt(e.target.value) || 1;
                    if (newQuantity < 1) {
                        e.target.value = 1;
                        updateCartItemQuantity(index, 1);
                    }
                });
            });
            
            document.querySelectorAll('.quantity-control-btn[data-action="decrease"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    decreaseCartQuantity(index);
                });
            });
            
            document.querySelectorAll('.quantity-control-btn[data-action="increase"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    increaseCartQuantity(index);
                });
            });
            
            document.querySelectorAll('.quantity-control-btn.remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    removeCartItem(index);
                });
            });
        }

        // NEW: Update cart item quantity manually
        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                newQuantity = 1;
            }
            
            const productId = cart[index].id;
            
            // Check product stock
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                if (product.stock !== undefined && newQuantity > product.stock) {
                    showNotification('Not enough stock available', 'error');
                    // Reset to previous quantity
                    document.querySelector(`.quantity-input[data-index="${index}"]`).value = cart[index].quantity;
                    return;
                }
                
                cart[index].quantity = newQuantity;
                updateCart();
            });
        }

        // NEW: Decrease cart item quantity
        function decreaseCartQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                updateCart();
            }
        }

        // NEW: Increase cart item quantity
        function increaseCartQuantity(index) {
            const productId = cart[index].id;
            
            // Check product stock
            database.ref('products/' + productId).once('value').then(snapshot => {
                const product = snapshot.val();
                if (product.stock !== undefined && cart[index].quantity >= product.stock) {
                    showNotification('Not enough stock available', 'error');
                    return;
                }
                
                cart[index].quantity++;
                updateCart();
            });
        }

        // NEW: Remove item from cart
        function removeCartItem(index) {
            const itemName = cart[index].name;
            cart.splice(index, 1);
            updateCart();
            showNotification(`${itemName} removed from cart`);
        }

        // Initialize the admin panel with enhanced cart
        function initAdmin() {
            // Previous initialization code remains the same...
            
            // Add enhanced cart initialization
            initEnhancedCart();
            
            // Rest of your existing initialization code...
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
     <script>
        // Global variables
        let currentLogoData = null;
        let currentLogoType = null;

        // DOM elements for logo upload
        const logoUpload = document.getElementById('logoUpload');
        const uploadLogoBtn = document.getElementById('uploadLogoBtn');
        const removeLogoBtn = document.getElementById('removeLogoBtn');
        const logoPreview = document.getElementById('logoPreview');
        const noLogoText = document.getElementById('noLogoText');

        // Initialize logo upload functionality
        function initLogoUpload() {
            // Upload logo button click
            uploadLogoBtn.addEventListener('click', () => {
                logoUpload.click();
            });
            
            // Logo file selection
            logoUpload.addEventListener('change', handleLogoUpload);
            
            // Remove logo button
            removeLogoBtn.addEventListener('click', removeLogo);
        }

        // Handle logo upload
        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file (PNG, JPG, JPEG)', 'error');
                return;
            }
            
            // Check file size (max 500KB)
            if (file.size > 500 * 1024) {
                showNotification('Image size should be less than 500KB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                // Store logo data
                currentLogoData = event.target.result;
                currentLogoType = file.type;
                
                // Display preview
                logoPreview.src = currentLogoData;
                logoPreview.style.display = 'block';
                noLogoText.style.display = 'none';
                removeLogoBtn.style.display = 'inline-block';
                
                showNotification('Logo uploaded successfully');
            };
            
            reader.readAsDataURL(file);
        }

        // Remove logo
        function removeLogo() {
            currentLogoData = null;
            currentLogoType = null;
            logoPreview.style.display = 'none';
            noLogoText.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUpload.value = '';
            
            showNotification('Logo removed');
        }

        // Load store settings with logo
        function loadStoreSettings() {
            database.ref('settings').once('value').then(snapshot => {
                const settings = snapshot.val();
                
                if (settings) {
                    if (settings.storeName) document.getElementById('storeName').value = settings.storeName;
                    if (settings.storeAddress) document.getElementById('storeAddress').value = settings.storeAddress;
                    if (settings.storePhone) document.getElementById('storePhone').value = settings.storePhone;
                    if (settings.storeEmail) document.getElementById('storeEmail').value = settings.storeEmail;
                    if (settings.bankDetails) document.getElementById('bankDetails').value = settings.bankDetails;
                    if (settings.tableCount) {
                        document.getElementById('tableCount').value = settings.tableCount;
                        tablesCount = settings.tableCount;
                    }
                    
                    // Load logo if exists
                    if (settings.logoData) {
                        currentLogoData = settings.logoData;
                        currentLogoType = settings.logoType;
                        
                        logoPreview.src = currentLogoData;
                        logoPreview.style.display = 'block';
                        noLogoText.style.display = 'none';
                        removeLogoBtn.style.display = 'inline-block';
                    }
                }
            });
        }

        // Save store settings with logo
        function saveStoreSettings(e) {
            e.preventDefault();
            
            const settings = {
                storeName: document.getElementById('storeName').value,
                storeAddress: document.getElementById('storeAddress').value,
                storePhone: document.getElementById('storePhone').value,
                storeEmail: document.getElementById('storeEmail').value,
                bankDetails: document.getElementById('bankDetails').value,
                tableCount: parseInt(document.getElementById('tableCount').value)
            };
            
            // Add logo data if exists
            if (currentLogoData) {
                settings.logoData = currentLogoData;
                settings.logoType = currentLogoType;
            }
            
            database.ref('settings').set(settings)
                .then(() => {
                    showNotification('Settings saved successfully!');
                    tablesCount = settings.tableCount;
                    loadTables();
                })
                .catch(error => {
                    showNotification('Error saving settings: ' + error.message, 'error');
                });
        }

        // Generate document HTML with centered logo and store name
        function generateDocumentHTML(type, document) {
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            
            // Create header with logo and store name
            const headerHTML = `
                <div class="invoice-header-center">
                    <div class="invoice-logo-container">
                        ${currentLogoData ? `<img src="${currentLogoData}" class="invoice-logo-img" alt="${storeName}">` : ''}
                        <div class="invoice-store-name">${storeName}</div>
                        <div class="invoice-store-details">
                            ${storeAddress ? `<p>${storeAddress}</p>` : ''}
                            <p>Tel: ${storePhone} ${storeEmail ? `| Email: ${storeEmail}` : ''}</p>
                        </div>
                    </div>
                    <div class="document-title">
                        ${type === 'quotation' ? 'QUOTATION' : 'INVOICE'}
                    </div>
                </div>
            `;
            
            return `
                ${headerHTML}
                
                <div class="invoice-details">
                    <div class="invoice-to">
                        <h3>${type === 'quotation' ? 'Quotation To:' : 'Bill To:'}</h3>
                        <p>${document.customer.name}</p>
                        <p>${document.customer.contact}</p>
                        <p>${document.customer.address || ''}</p>
                    </div>
                    
                    <div class="invoice-from">
                        <p><strong>${type === 'quotation' ? 'Quotation' : 'Invoice'} #:</strong> ${document.number}</p>
                        <p><strong>Date:</strong> ${document.date}</p>
                        ${type === 'quotation' ? `<p><strong>Valid Until:</strong> ${document.validUntil}</p>` : `<p><strong>Due Date:</strong> ${document.dueDate}</p>`}
                    </div>
                </div>
                
                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${document.items.map(item => `
                            <tr>
                                <td>${item.product}</td>
                                <td>${item.quantity}</td>
                                <td>MVR ${item.price.toFixed(2)}</td>
                                <td>MVR ${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="invoice-total-row grand-total">
                            <td colspan="3">Total</td>
                            <td>MVR ${document.total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                ${document.notes ? `<div class="document-notes"><p><strong>Notes:</strong> ${document.notes}</p></div>` : ''}
                
                <div class="invoice-footer">
                    <p>Thank you for your business!</p>
                    <p>${storeName}</p>
                </div>
            `;
        }

        // Generate invoice HTML for orders
        function generateInvoiceHTML(order) {
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            
            // Create header with logo and store name
            const headerHTML = `
                <div class="invoice-header-center">
                    <div class="invoice-logo-container">
                        ${currentLogoData ? `<img src="${currentLogoData}" class="invoice-logo-img" alt="${storeName}">` : ''}
                        <div class="invoice-store-name">${storeName}</div>
                        <div class="invoice-store-details">
                            ${storeAddress ? `<p>${storeAddress}</p>` : ''}
                            <p>Tel: ${storePhone} ${storeEmail ? `| Email: ${storeEmail}` : ''}</p>
                        </div>
                    </div>
                    <div class="document-title">
                        INVOICE
                    </div>
                </div>
            `;
            
            return `
                ${headerHTML}
                
                <div class="invoice-details">
                    <div class="invoice-to">
                        <h3>Bill To:</h3>
                        <p>${order.customer?.name || 'Cash Customer'}</p>
                        <p>${order.customer?.contact || ''}</p>
                        <p>${order.customer?.address || ''}</p>
                    </div>
                    
                    <div class="invoice-from">
                        <p><strong>Invoice #:</strong> ${order.orderNumber}</p>
                        <p><strong>Date:</strong> ${order.date || new Date().toISOString().split('T')[0]}</p>
                        <p><strong>Order Type:</strong> ${order.orderType === 'dining' ? 'Dining' : 'Takeaway'}</p>
                        ${order.table ? `<p><strong>Table:</strong> ${order.table}</p>` : ''}
                    </div>
                </div>
                
                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>MVR ${item.price.toFixed(2)}</td>
                                <td>MVR ${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="invoice-total-row grand-total">
                            <td colspan="3">Total</td>
                            <td>MVR ${order.total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="payment-details">
                    <p><strong>Payment Method:</strong> ${order.paymentMethod === 'cash' ? 'Cash' : order.paymentMethod === 'credit' ? 'Credit' : 'Bank Transfer'}</p>
                    <p><strong>Status:</strong> ${order.status || 'completed'}</p>
                </div>
                
                <div class="invoice-footer">
                    <p>Thank you for your business!</p>
                    <p>${storeName}</p>
                </div>
            `;
        }

        // Download document as PDF with centered logo and store name
        function downloadDocumentAsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get settings
            const storeName = document.getElementById('storeName').value || 'symcodermv-cafe';
            const storeAddress = document.getElementById('storeAddress').value || '';
            const storePhone = document.getElementById('storePhone').value || '';
            const storeEmail = document.getElementById('storeEmail').value || '';
            const bankDetails = document.getElementById('bankDetails').value || '';
            
            let yPosition = 15;
            
            // Add logo if available
            if (currentLogoData) {
                try {
                    // Convert data URL to image
                    const img = new Image();
                    img.src = currentLogoData;
                    
                    // Wait for image to load
                    img.onload = function() {
                        // Calculate dimensions to maintain aspect ratio
                        const maxWidth = 40;
                        const ratio = maxWidth / img.width;
                        const height = img.height * ratio;
                        
                        // Center the logo
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const logoX = (pageWidth - maxWidth) / 2;
                        
                        doc.addImage(currentLogoData, 'PNG', logoX, yPosition, maxWidth, height);
                        yPosition += height + 5;
                        
                        continuePDFGeneration(doc, yPosition, storeName, storeAddress, storePhone, storeEmail, bankDetails);
                    };
                    
                    img.onerror = function() {
                        // Fallback to text store name
                        doc.setFontSize(16);
                        doc.text(storeName, 105, yPosition, { align: 'center' });
                        yPosition += 10;
                        
                        continuePDFGeneration(doc, yPosition, storeName, storeAddress, storePhone, storeEmail, bankDetails);
                    };
                } catch (error) {
                    console.error('Error loading logo:', error);
                    // Fallback to text store name
                    doc.setFontSize(16);
                    doc.text(storeName, 105, yPosition, { align: 'center' });
                    yPosition += 10;
                    
                    continuePDFGeneration(doc, yPosition, storeName, storeAddress, storePhone, storeEmail, bankDetails);
                }
            } else {
                // Text store name (centered)
                doc.setFontSize(16);
                doc.text(storeName, 105, yPosition, { align: 'center' });
                yPosition += 10;
                
                continuePDFGeneration(doc, yPosition, storeName, storeAddress, storePhone, storeEmail, bankDetails);
            }
        }

        // Continue PDF generation after logo processing
        function continuePDFGeneration(doc, yPosition, storeName, storeAddress, storePhone, storeEmail, bankDetails) {
            // Add company details (centered)
            doc.setFontSize(10);
            if (storeAddress) {
                doc.text(storeAddress, 105, yPosition, { align: 'center' });
                yPosition += 5;
            }
            
            let contactInfo = `Tel: ${storePhone}`;
            if (storeEmail) {
                contactInfo += ` | Email: ${storeEmail}`;
            }
            doc.text(contactInfo, 105, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Add document title (centered)
            doc.setFontSize(16);
            doc.text(currentDocument.type === 'quotation' ? 'QUOTATION' : 'INVOICE', 105, yPosition, { align: 'center' });
            yPosition += 15;
            
            // Add document details
            doc.setFontSize(10);
            doc.text(`Date: ${currentDocument.date}`, 14, yPosition);
            if (currentDocument.type === 'quotation') {
                doc.text(`Valid Until: ${currentDocument.validUntil}`, 14, yPosition + 5);
                yPosition += 10;
            } else {
                doc.text(`Due Date: ${currentDocument.dueDate}`, 14, yPosition + 5);
                yPosition += 10;
            }
            doc.text(`${currentDocument.type === 'quotation' ? 'Quotation' : 'Invoice'} #: ${currentDocument.number}`, 14, yPosition);
            
            // Add customer details
            yPosition += 15;
            doc.setFontSize(12);
            doc.text(currentDocument.type === 'quotation' ? 'Quotation To:' : 'Bill To:', 14, yPosition);
            doc.setFontSize(10);
            doc.text(currentDocument.customer.name, 14, yPosition + 5);
            doc.text(currentDocument.customer.contact, 14, yPosition + 10);
            doc.text(currentDocument.customer.address || '', 14, yPosition + 15);
            
            // Add items table
            const tableColumn = ["Description", "Qty", "Price", "Total"];
            const tableRows = [];
            
            currentDocument.items.forEach(item => {
                const itemData = [
                    item.product,
                    item.quantity.toString(),
                    `MVR ${item.price.toFixed(2)}`,
                    `MVR ${item.total.toFixed(2)}`
                ];
                tableRows.push(itemData);
            });
            
            // Add total row
            tableRows.push([
                "",
                "",
                "Total:",
                `MVR ${currentDocument.total.toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: yPosition + 20,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [74, 158, 91] }
            });
            
            // Add notes if available
            let finalY = doc.lastAutoTable.finalY + 10;
            if (currentDocument.notes) {
                doc.text(`Notes: ${currentDocument.notes}`, 14, finalY);
                finalY += 10;
            }
            
            // Add bank details if available
            if (bankDetails) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Bank Details:', 14, finalY);
                doc.setFont(undefined, 'normal');
                
                const bankLines = bankDetails.split('\n');
                bankLines.forEach((line, index) => {
                    doc.text(line, 14, finalY + 5 + (index * 5));
                });
                
                finalY += 10 + (bankLines.length * 5);
            }
            
            // Add footer (centered)
            doc.setFontSize(10);
            doc.text('Thank you for your business!', 105, finalY + 10, { align: 'center' });
            doc.text(storeName, 105, finalY + 15, { align: 'center' });
            
            // Save the PDF
            doc.save(`${currentDocument.type}-${currentDocument.number}.pdf`);
        }

        // Initialize the admin panel with logo upload
        function initAdmin() {
            // Previous initialization code remains the same...
            
            // Add logo upload initialization
            initLogoUpload();
            
            // Rest of your existing initialization code...
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>
</html>